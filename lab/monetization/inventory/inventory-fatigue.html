<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Усталость инвентаря</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background-color: #ffffff;
            padding: 3rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.1rem;
            font-weight: 400;
            color: #666;
            margin-bottom: 3rem;
            font-style: italic;
        }

        .intro {
            max-width: 700px;
            margin-bottom: 4rem;
        }

        .intro p {
            font-size: 1rem;
            line-height: 1.7;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        .section {
            margin-bottom: 4rem;
        }

        .section-title {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 2rem;
            font-weight: 500;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        @media (min-width: 600px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            padding: 1.25rem;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            background: #fafafa;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 0.75rem;
        }

        .card-item {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 0.75rem;
        }

        .card-item strong {
            color: #1a1a1a;
            font-weight: 500;
        }

        .card-item:last-child {
            margin-bottom: 0;
        }

        .card-list {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #2c3e50;
            padding-left: 1.25rem;
            margin-top: 0.5rem;
        }

        .card-list li {
            margin-bottom: 0.4rem;
        }

        .chart-container {
            margin: 3rem 0;
            padding: 1.5rem;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }

        .chart-caption {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
            margin-top: 1rem;
            max-width: 700px;
        }

        .interactive-panel {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
            padding: 1.5rem;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }

        @media (min-width: 900px) {
            .interactive-panel {
                grid-template-columns: 1fr 1.5fr;
            }
        }

        .controls-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-label {
            font-size: 0.9rem;
            color: #666;
        }

        .control-slider {
            width: 100%;
            margin-top: 0.5rem;
        }

        .control-value {
            font-size: 0.85rem;
            color: #999;
            margin-top: 0.25rem;
        }

        .control-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-checkbox input[type="checkbox"] {
            cursor: pointer;
        }

        .control-checkbox label {
            font-size: 0.9rem;
            color: #2c3e50;
            cursor: pointer;
        }

        .output-panel {
            padding: 1.25rem;
            background: #fafafa;
            border-radius: 4px;
            font-size: 0.9rem;
            line-height: 1.7;
            color: #2c3e50;
        }

        .output-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .output-metric {
            padding: 0.75rem;
            background: #ffffff;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }

        .output-metric-label {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 0.25rem;
        }

        .output-metric-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: #1a1a1a;
        }

        .output-conclusion {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #ffffff;
            border-left: 3px solid #1f2a37;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .fatigue-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 3rem;
            font-size: 0.9rem;
        }

        .fatigue-table th,
        .fatigue-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }

        .fatigue-table th {
            background: #fafafa;
            font-weight: 500;
            color: #1a1a1a;
        }

        .fatigue-table td {
            color: #2c3e50;
        }

        .checklist {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #2c3e50;
            padding-left: 1.25rem;
            margin-bottom: 3rem;
        }

        .checklist li {
            margin-bottom: 0.75rem;
        }

        .next-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 3rem;
        }

        @media (min-width: 600px) {
            .next-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .next-card {
            padding: 3rem 1rem;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            text-decoration: none;
            color: inherit;
            display: block;
            transition: border-color 0.2s ease;
        }

        .next-card:hover {
            border-color: #999;
        }

        .next-card-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .next-card-text {
            font-size: 0.85rem;
            color: #666;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 0.5rem;
            color: #666;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: #1a1a1a;
        }

        .back-link.secondary {
            font-size: 0.8rem;
            color: #999;
            margin-left: 1rem;
        }

        .footer {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid #e8e8e8;
        }

        .footer-note {
            font-size: 0.85rem;
            color: #999;
            font-style: italic;
            margin-top: 1rem;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #e8e8e8;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #1f2a37;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #1f2a37;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../../../index.html" class="back-to-home">← На главную</a>

        
        <h1>Усталость инвентаря</h1>
        <p class="subtitle">Повторение дешевле в объёме — и дороже в внимании.</p>

        <div class="intro">
            <p>
                Усталость — это деградация отдачи при росте повторения. Система может показывать рекламу чаще, но каждый дополнительный показ даёт всё меньше эффекта. Первые касания работают, дальше начинается выгорание. Пользователь видит рекламу слишком часто, внимание устаёт, CTR падает, эффективность деградирует.
            </p>
            <p>
                Деньги часто реагируют с лагом: сначала падает внимание/CTR, потом RPM, потом revenue. Система может показывать больше (shows растут), но эффективность падает (CTR/RPM снижаются). CPM может оставаться стабильным, пока RPM деградирует. Среднее может выглядеть терпимо, пока high-pressure сегмент ломается первым.
            </p>
            <p>
                Ошибка: "дожимать" показами то, что уже выгорело. Рост частоты может временно поднять shows, но ухудшить качество и конверсию. Нужно не увеличивать частоту, а вводить caps, spacing, защищать сегменты, возвращать разнообразие.
            </p>
        </div>

        <div class="section">
            <div class="section-title">Как выглядит усталость</div>
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">Shows держатся, CTR падает</div>
                    <div class="card-item">
                        <strong>Симптом:</strong> Количество показов стабильно или растёт, но CTR снижается.
                    </div>
                    <div class="card-item">
                        <strong>Механизм:</strong> Частота растёт, внимание устаёт, пользователь перестаёт реагировать на повторяющиеся показы.
                    </div>
                    <div class="card-item">
                        <strong>Что проверить:</strong>
                        <ul class="card-list">
                            <li>CTR/attention decay by frequency bucket: падает ли CTR с ростом частоты</li>
                            <li>Marginal RPM by frequency: падает ли эффективность дополнительных показов</li>
                            <li>Share of 7+ bucket: не растёт ли доля пользователей с высокой частотой</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">CPM держится, RPM падает</div>
                    <div class="card-item">
                        <strong>Симптом:</strong> Цена за показ стабильна, но эффективность (RPM) снижается.
                    </div>
                    <div class="card-item">
                        <strong>Механизм:</strong> Компенсация ценой маскирует падение эффективности. CPM остаётся высоким, пока RPM деградирует.
                    </div>
                    <div class="card-item">
                        <strong>Что проверить:</strong>
                        <ul class="card-list">
                            <li>Стабилизация CPM при падении RPM: не компенсация ли ценой</li>
                            <li>Lagged revenue decline: не лаг ли между показом и эффектом</li>
                            <li>P10 effectiveness drop: не деградирует ли нижний дециль</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Среднее норм, high-pressure сегмент ломается</div>
                    <div class="card-item">
                        <strong>Симптом:</strong> Средние метрики стабильны, но high-pressure сегмент деградирует первым.
                    </div>
                    <div class="card-item">
                        <strong>Механизм:</strong> Усталость проявляется раньше в сегментах с высокой частотой. Среднее маскирует проблемы в отдельных сегментах.
                    </div>
                    <div class="card-item">
                        <strong>Что проверить:</strong>
                        <ul class="card-list">
                            <li>Variance growth: не растёт ли дисперсия между сегментами</li>
                            <li>Segment divergence: не расходится ли эффективность по сегментам</li>
                            <li>P10 effectiveness drop: не деградирует ли нижний дециль</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Эффект падает после N экспозиций</div>
                    <div class="card-item">
                        <strong>Симптом:</strong> Эффективность резко падает после определённого числа показов одному пользователю.
                    </div>
                    <div class="card-item">
                        <strong>Механизм:</strong> Кривая отдачи от частоты имеет точку излома. После порога каждый дополнительный показ даёт всё меньше эффекта.
                    </div>
                    <div class="card-item">
                        <strong>Что проверить:</strong>
                        <ul class="card-list">
                            <li>Frequency buckets: распределение пользователей по частоте</li>
                            <li>Marginal value by frequency: падение эффективности дополнительных показов</li>
                            <li>Crowding proxy рост: не конкурируют ли возможности за внимание</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Кривая отдачи от частоты</div>
            <div class="chart-container">
                <svg id="frequencyChart"></svg>
                <p class="chart-caption">Первые касания дают эффект. Дальше начинается выгорание.</p>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Во времени: частота растёт, эффективность падает</div>
            <div class="chart-container">
                <svg id="timeChart"></svg>
                <p class="chart-caption">Усталость сначала бьёт по вниманию, затем по деньгам.</p>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Buckets по частоте (распределение пользователей)</div>
            <div class="chart-container">
                <svg id="bucketsChart"></svg>
                <p class="chart-caption">Усталость приходит, когда хвост 7+ растёт.</p>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Подбери cap и spacing</div>
            <div class="interactive-panel">
                <div class="controls-group">
                    <div class="control-group">
                        <label class="control-label">Cap (макс частота)</label>
                        <input type="range" id="capSlider" class="control-slider" min="1" max="12" value="6">
                        <div class="control-value" id="capValue">6</div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Spacing (разнесение касаний)</label>
                        <input type="range" id="spacingSlider" class="control-slider" min="0" max="100" value="50">
                        <div class="control-value" id="spacingValue">50</div>
                    </div>
                    <div class="control-group">
                        <div class="control-checkbox">
                            <input type="checkbox" id="protectSegment" checked>
                            <label for="protectSegment">Protect high-pressure сегмент</label>
                        </div>
                    </div>
                </div>
                <div class="output-panel" id="outputPanel">
                    <!-- Content will be populated by JS -->
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Прокси усталости</div>
            <table class="fatigue-table">
                <thead>
                    <tr>
                        <th>Прокси</th>
                        <th>Что значит</th>
                        <th>Как интерпретировать</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>CTR/attention decay by frequency bucket</td>
                        <td>Падение CTR/внимания с ростом частоты</td>
                        <td>Если CTR падает в бакетах 4-6 и 7+ — усталость</td>
                    </tr>
                    <tr>
                        <td>Marginal RPM by frequency</td>
                        <td>Эффективность дополнительных показов</td>
                        <td>Если marginal RPM падает после 4-5 показов — выгорание</td>
                    </tr>
                    <tr>
                        <td>Share of 7+ bucket</td>
                        <td>Доля пользователей с частотой 7+</td>
                        <td>Если доля 7+ растёт — усталость накапливается</td>
                    </tr>
                    <tr>
                        <td>P10 effectiveness drop</td>
                        <td>Падение эффективности в нижнем дециле</td>
                        <td>Если p10 падает быстрее среднего — усталость в хвостах</td>
                    </tr>
                    <tr>
                        <td>Variance growth</td>
                        <td>Рост дисперсии эффективности</td>
                        <td>Если variance растёт — система становится хрупкой</td>
                    </tr>
                    <tr>
                        <td>Session depth proxy падение</td>
                        <td>Падение эффективности с глубиной сессии</td>
                        <td>Если эффективность падает в глубоких сессиях — усталость</td>
                    </tr>
                    <tr>
                        <td>Lagged revenue decline</td>
                        <td>Запаздывающее падение revenue</td>
                        <td>Если revenue падает позже CTR — лаг усталости</td>
                    </tr>
                    <tr>
                        <td>Стабилизация CPM при падении RPM</td>
                        <td>CPM стабилен, RPM падает</td>
                        <td>Компенсация ценой маскирует падение эффективности</td>
                    </tr>
                    <tr>
                        <td>Response ratio стабильный</td>
                        <td>Доступность спроса не меняется</td>
                        <td>Если response ratio стабилен — проблема не в delivery, а в усталости</td>
                    </tr>
                    <tr>
                        <td>Crowding proxy рост</td>
                        <td>Рост конкуренции возможностей за внимание</td>
                        <td>Если crowding растёт — несколько возможностей конкурируют</td>
                    </tr>
                    <tr>
                        <td>Frequency distribution shift</td>
                        <td>Сдвиг в распределении частоты</td>
                        <td>Если хвост 7+ растёт, а 1-3 падает — усталость накапливается</td>
                    </tr>
                    <tr>
                        <td>Marginal value curve</td>
                        <td>Кривая отдачи от частоты</td>
                        <td>Если кривая падает экспоненциально — выгорание</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">Если выгорание — что делать</div>
            <ul class="checklist">
                <li>Сегментировать по частоте — разделить пользователей на бакеты (1, 2-3, 4-6, 7+) и смотреть эффективность по бакетам</li>
                <li>Вводить caps и spacing — ограничить максимальную частоту и разнести касания во времени</li>
                <li>Защищать high-pressure сегмент — не дожимать частоту в сегментах с высокой частотой</li>
                <li>Уменьшать низкокачественные opportunities — не показывать рекламу в контекстах с низким вниманием</li>
                <li>Следить за хвостами (7+) — мониторить долю пользователей с высокой частотой</li>
                <li>Не судить по CPM — CPM может оставаться стабильным, пока RPM деградирует</li>
                <li>Фиксировать окна и лаги — усталость проявляется с лагом, нужно смотреть на окне лагов</li>
                <li>Мониторить восстановление по ранним сигналам — CTR/attention реагируют раньше revenue</li>
                <li>Обновить guardrails (pressure/quality) — установить пороги для частоты и качества</li>
                <li>Вернуть разнообразие (rotation/diversification) — не показывать одно и то же, менять форматы/места</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">Куда дальше</div>
            <div class="next-cards">
                <a href="../pressure/index.html" class="next-card">
                    <div class="next-card-title">Давление и насыщение →</div>
                    <div class="next-card-text">Давление и насыщение в монетизации.</div>
                </a>
                <a href="../operating/cadence.html" class="next-card">
                    <div class="next-card-title">Эксплуатация системы: ритм контроля →</div>
                    <div class="next-card-text">Ритм контроля монетизации.</div>
                </a>
                <a href="./inventory-metrics.html" class="next-card">
                    <div class="next-card-title">Метрики инвентаря →</div>
                    <div class="next-card-text">Что мерить и как считать. Словарь метрик и калькуляторы.</div>
                </a>
            </div>
        </div>

        <div class="footer">
            <a href="./index.html" class="back-link">← Назад к Инвентарю</a>
            <p class="footer-note">Повторение дешевле в объёме — и дороже в внимании.</p>
        </div>
    </div>

    <script>
        // Frequency curve chart
        function generateFrequencyChart() {
            const container = d3.select('#frequencyChart').node().parentElement;
            const margin = { top: 20, right: 20, bottom: 40, left: 50 };
            const width = Math.min(container.clientWidth, 800) - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            d3.select('#frequencyChart').selectAll('*').remove();

            const svg = d3.select('#frequencyChart')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Generate data: exponential decay
            const n = 12;
            const k = 0.25;
            const floor = 0.15;
            const data = [];
            for (let i = 1; i <= n; i++) {
                const value = Math.exp(-k * (i - 1)) + floor;
                data.push({ frequency: i, value });
            }

            const x = d3.scaleLinear()
                .domain([1, n])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, 1.2])
                .range([height, 0]);

            // Useful cap line (around frequency 5)
            const cap = 5;
            g.append('line')
                .attr('x1', x(cap))
                .attr('x2', x(cap))
                .attr('y1', 0)
                .attr('y2', height)
                .attr('stroke', '#999')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3');

            g.append('text')
                .attr('x', x(cap))
                .attr('y', height - 5)
                .attr('text-anchor', 'middle')
                .attr('font-size', '10px')
                .attr('fill', '#999')
                .text('полезный cap');

            // Line
            const line = d3.line()
                .x(d => x(d.frequency))
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#1f2a37')
                .attr('stroke-width', 2)
                .attr('d', line);

            // Axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(n).tickFormat(d => d))
                .attr('font-size', '11px')
                .attr('color', '#999');

            g.append('g')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.1f')))
                .attr('font-size', '11px')
                .attr('color', '#999');

            // Labels
            g.append('text')
                .attr('x', width / 2)
                .attr('y', height + 35)
                .attr('text-anchor', 'middle')
                .attr('font-size', '11px')
                .attr('fill', '#666')
                .text('frequency');

            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -35)
                .attr('text-anchor', 'middle')
                .attr('font-size', '11px')
                .attr('fill', '#666')
                .text('marginal value index');
        }

        // Time chart
        function generateTimeChart() {
            const container = d3.select('#timeChart').node().parentElement;
            const margin = { top: 20, right: 80, bottom: 40, left: 50 };
            const width = Math.min(container.clientWidth, 800) - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            d3.select('#timeChart').selectAll('*').remove();

            const svg = d3.select('#timeChart')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Generate data
            const n = 200;
            const freqStart = 90;
            const qualityStart = 100;
            const revenueStart = 130;
            const data = [];
            for (let t = 1; t <= n; t++) {
                // Frequency: grows after freqStart
                const freqGrowth = t > freqStart ? 0.35 * (1 - 1 / (1 + Math.exp(-(t - freqStart) / 8))) : 0;
                const frequency = 0.40 + freqGrowth;

                // Quality/CTR: drops after qualityStart
                const qualityDrop = t > qualityStart ? 0.25 * (1 - 1 / (1 + Math.exp(-(t - qualityStart) / 10))) : 0;
                const quality = 0.75 - qualityDrop;

                // Revenue: reacts later
                const revenueDrop = t > revenueStart ? 0.20 * (1 - 1 / (1 + Math.exp(-(t - revenueStart) / 8))) : 0;
                const revenue = 0.80 - revenueDrop;

                data.push({ t, frequency, quality, revenue });
            }

            const x = d3.scaleLinear()
                .domain([1, n])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0.3, 1.0])
                .range([height, 0]);

            // Markers
            const t0 = freqStart;
            const t1 = qualityStart;
            const t2 = revenueStart;

            [t0, t1, t2].forEach((t, i) => {
                g.append('line')
                    .attr('x1', x(t))
                    .attr('x2', x(t))
                    .attr('y1', 0)
                    .attr('y2', height)
                    .attr('stroke', '#999')
                    .attr('stroke-width', 1)
                    .attr('stroke-dasharray', '3,3');

                const labels = ['t0: рост частоты', 't1: падение эффективности', 't2: реакция денег'];
                g.append('text')
                    .attr('x', x(t))
                    .attr('y', height - 5 - i * 15)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', '#999')
                    .text(labels[i]);
            });

            // Lines
            const lineFrequency = d3.line()
                .x(d => x(d.t))
                .y(d => y(d.frequency))
                .curve(d3.curveMonotoneX);

            const lineQuality = d3.line()
                .x(d => x(d.t))
                .y(d => y(d.quality))
                .curve(d3.curveMonotoneX);

            const lineRevenue = d3.line()
                .x(d => x(d.t))
                .y(d => y(d.revenue))
                .curve(d3.curveMonotoneX);

            g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#1f2a37')
                .attr('stroke-width', 2)
                .attr('d', lineFrequency);

            g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#999')
                .attr('stroke-width', 2)
                .attr('d', lineQuality);

            g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#aaa')
                .attr('stroke-width', 2)
                .attr('d', lineRevenue);

            // Axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d => `t${d}`))
                .attr('font-size', '11px')
                .attr('color', '#999');

            g.append('g')
                .call(d3.axisLeft(y).ticks(5))
                .attr('font-size', '11px')
                .attr('color', '#999');

            // Labels
            g.append('text')
                .attr('x', width - 10)
                .attr('y', y(data[data.length - 1].frequency) + 5)
                .attr('text-anchor', 'end')
                .attr('font-size', '10px')
                .attr('fill', '#1f2a37')
                .text('frequency_proxy');

            g.append('text')
                .attr('x', width - 10)
                .attr('y', y(data[data.length - 1].quality) + 5)
                .attr('text-anchor', 'end')
                .attr('font-size', '10px')
                .attr('fill', '#999')
                .text('attention/CTR proxy');

            g.append('text')
                .attr('x', width - 10)
                .attr('y', y(data[data.length - 1].revenue) + 5)
                .attr('text-anchor', 'end')
                .attr('font-size', '10px')
                .attr('fill', '#aaa')
                .text('revenue');
        }

        // Buckets chart
        function generateBucketsChart() {
            const container = d3.select('#bucketsChart').node().parentElement;
            const margin = { top: 20, right: 20, bottom: 40, left: 50 };
            const width = Math.min(container.clientWidth, 800) - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            d3.select('#bucketsChart').selectAll('*').remove();

            const svg = d3.select('#bucketsChart')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Generate data
            const buckets = ['1', '2-3', '4-6', '7+'];
            const baseline = [0.35, 0.30, 0.20, 0.15];
            const after = [0.25, 0.25, 0.25, 0.25];

            const x0 = d3.scaleBand()
                .domain(buckets)
                .range([0, width])
                .paddingInner(0.2)
                .paddingOuter(0.1);

            const x1 = d3.scaleBand()
                .domain(['baseline', 'after'])
                .range([0, x0.bandwidth()])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, 0.5])
                .range([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(['baseline', 'after'])
                .range(['#999', '#1f2a37']);

            buckets.forEach((bucket, i) => {
                const bucketGroup = g.append('g')
                    .attr('transform', `translate(${x0(bucket)}, 0)`);

                ['baseline', 'after'].forEach((state, j) => {
                    const value = state === 'baseline' ? baseline[i] : after[i];
                    bucketGroup.append('rect')
                        .attr('x', x1(state))
                        .attr('y', y(value))
                        .attr('width', x1.bandwidth())
                        .attr('height', height - y(value))
                        .attr('fill', color(state));
                });
            });

            // Axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x0))
                .attr('font-size', '11px')
                .attr('color', '#999');

            g.append('g')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.1f')))
                .attr('font-size', '11px')
                .attr('color', '#999');

            // Legend
            const legend = g.append('g')
                .attr('transform', `translate(${width - 60}, 10)`);

            ['baseline', 'after'].forEach((state, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 20})`);

                legendRow.append('rect')
                    .attr('width', 12)
                    .attr('height', 12)
                    .attr('fill', color(state));

                legendRow.append('text')
                    .attr('x', 18)
                    .attr('y', 9)
                    .attr('font-size', '10px')
                    .attr('fill', '#2c3e50')
                    .text(state === 'baseline' ? 'baseline' : 'after');
            });
        }

        // Interactive calculator
        function updateCalculator() {
            const cap = parseInt(document.getElementById('capSlider').value);
            const spacing = parseInt(document.getElementById('spacingSlider').value);
            const protectSegment = document.getElementById('protectSegment').checked;

            // Deterministic formulas
            // Shows: grow with cap, but with diminishing returns
            const showsBase = 0.65;
            const showsFromCap = (cap / 12) * 0.25;
            const showsDiminishing = 1 - Math.exp(-cap / 3);
            const showsIndex = Math.min(1.0, showsBase + showsFromCap * showsDiminishing);

            // Quality: drops with cap, but improves with spacing and protection
            const qualityBase = 0.75;
            const qualityDropFromCap = (cap / 12) * 0.20;
            const qualityGainFromSpacing = (spacing / 100) * 0.15;
            const qualityGainFromProtection = protectSegment ? 0.10 : 0;
            const qualityIndex = Math.max(0.4, qualityBase - qualityDropFromCap + qualityGainFromSpacing + qualityGainFromProtection);

            // Revenue: shows * quality
            const revenueIndex = showsIndex * qualityIndex;

            // Diagnosis
            let diagnosis = '';
            if (qualityIndex > 0.65 && revenueIndex > 0.55) {
                diagnosis = 'Безопасно. Cap и spacing в норме, quality защищён.';
            } else if (qualityIndex > 0.55 && revenueIndex > 0.50) {
                diagnosis = 'На пороге. Quality начинает падать, нужно уменьшить cap или увеличить spacing.';
            } else {
                diagnosis = 'Выгорание. Quality слишком низок, revenue падает. Уменьшите cap, увеличьте spacing, защитите сегмент.';
            }

            document.getElementById('outputPanel').innerHTML = `
                <div class="output-metrics">
                    <div class="output-metric">
                        <div class="output-metric-label">Shows index</div>
                        <div class="output-metric-value">${(showsIndex * 100).toFixed(0)}</div>
                    </div>
                    <div class="output-metric">
                        <div class="output-metric-label">Quality index</div>
                        <div class="output-metric-value">${(qualityIndex * 100).toFixed(0)}</div>
                    </div>
                    <div class="output-metric">
                        <div class="output-metric-label">Revenue index</div>
                        <div class="output-metric-value">${(revenueIndex * 100).toFixed(0)}</div>
                    </div>
                </div>
                <div class="output-conclusion">${diagnosis}</div>
            `;
        }

        document.getElementById('capSlider').addEventListener('input', (e) => {
            document.getElementById('capValue').textContent = e.target.value;
            updateCalculator();
        });

        document.getElementById('spacingSlider').addEventListener('input', (e) => {
            document.getElementById('spacingValue').textContent = e.target.value;
            updateCalculator();
        });

        document.getElementById('protectSegment').addEventListener('change', updateCalculator);

        // Initial render
        generateFrequencyChart();
        generateTimeChart();
        generateBucketsChart();
        updateCalculator();

        // Responsive resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                generateFrequencyChart();
                generateTimeChart();
                generateBucketsChart();
            }, 250);
        });
    </script>
    <script>
        (function () {
            const current = window.location.pathname.replace(/\/$/, "");
            links.forEach(a => {
                const href = a.getAttribute("href");
                if (!href) return;
                const normalized = href.replace(/\/$/, "");
                if (normalized === current || current.endsWith(normalized)) {
                    a.classList.add("active");
                    a.setAttribute("aria-current", "page");
                    const section = a.closest(".nav-section");
                    if (section) section.classList.add("active-section");
                }
            });
        })();
    </script>
</body>
</html>

