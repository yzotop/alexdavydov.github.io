<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сегменты спорят друг с другом (Simpson)</title>
    <script src="../assets/vendor/d3.v7.min.js"></script>
    <link rel="stylesheet" href="../assets/css/ab_charts.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background-color: #ffffff;
            padding: 3rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }

        .subtitle {
            font-size: 1rem;
            font-weight: 400;
            color: #666;
            margin-bottom: 2rem;
            font-style: italic;
        }

        h2 {
            font-size: 1.3rem;
            font-weight: 400;
            margin-top: 3rem;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }

        .context {
            max-width: 700px;
            margin-bottom: 3rem;
        }

        .context p {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #1a1a1a;
            margin-bottom: 0.75rem;
        }

        .think-block {
            max-width: 700px;
            margin: 3rem 0;
            padding: 1.5rem;
            background: #fafafa;
            border-left: 3px solid #1a1a1a;
            border-radius: 3px;
        }

        .think-block h3 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }

        .think-block ul {
            list-style: none;
            padding-left: 0;
        }

        .think-block li {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #1a1a1a;
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .think-block li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #666;
        }

        .analysis {
            max-width: 700px;
            margin: 3rem 0;
        }

        .analysis h3 {
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }

        .analysis p {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #1a1a1a;
            margin-bottom: 1rem;
        }

        .analysis ul, .analysis ol {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .analysis li {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .conclusion {
            max-width: 700px;
            margin: 3rem 0;
            padding: 1.5rem;
            background: #fafafa;
            border-radius: 4px;
        }

        .conclusion h3 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }

        .conclusion-section {
            margin-bottom: 1.5rem;
        }

        .conclusion-section-title {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }

        .conclusion-section-content {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #1a1a1a;
        }

        .related-topics {
            max-width: 700px;
            margin: 3rem 0;
            padding: 1rem;
            background: #fafafa;
            border-radius: 4px;
        }

        .related-topics h3 {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: #1a1a1a;
        }

        .related-topics ul {
            list-style: none;
            padding-left: 0;
        }

        .related-topics li {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .related-topics a {
            color: #666;
            text-decoration: none;
            border-bottom: 1px solid #ccc;
            transition: border-color 0.2s ease;
        }

        .related-topics a:hover {
            border-color: #999;
        }

        details {
            margin: 2rem 0;
        }

        summary {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #ffffff;
            color: #ffffff;
            border-radius: 4px;
            font-size: 0.95rem;
            cursor: pointer;
            user-select: none;
        }

        summary:hover {
            background: #333;
        }

        details[open] summary {
            margin-bottom: 2rem;
        }

        .back-to-home {
            display: inline-block;
            margin-bottom: 1rem;
            color: #666;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .back-to-home:hover {
            color: #1a1a1a;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #666;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .nav-links a.active {
            color: #1a1a1a;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: #1a1a1a;
        }

        .scenario-nav {
            max-width: 700px;
            margin: 3rem 0 2rem 0;
            padding: 1rem 0;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .scenario-nav a {
            display: inline-block;
            padding: 0.5rem 1rem;
            color: #666;
            text-decoration: none;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease, color 0.2s ease;
        }

        .scenario-nav a:hover {
            border-color: #999;
            color: #1a1a1a;
        }

        .scenario-nav .nav-disabled {
            color: #ccc;
            border-color: #f0f0f0;
            cursor: default;
            pointer-events: none;
        }

        .chart-panel-title {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: #1a1a1a;
        }

        @media (max-width: 600px) {
            .scenario-nav {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../../index.html" class="back-to-home">← На главную</a>

        <div class="nav-links">
            <a href="/lab/ab-decisions/index.html">Курс</a>
            <a href="../index.html" class="active">Практика</a>
            <a href="../syllabus.html">Программа</a>
            <a href="../checklist.html">Чеклист</a>
        </div>
        <h1>Сегменты спорят друг с другом (Simpson)</h1>
        <p class="subtitle">В целом тест "плюс", но в каждом сегменте — "минус" (или наоборот).</p>
        <p style="font-size: 0.85rem; color: #666; margin-top: -0.5rem; margin-bottom: 1.5rem;">
            <a href="../../index.html#lesson-2" style="color: #666; text-decoration: none; border-bottom: 1px solid #ccc;">Урок: Можно ли масштабировать</a>
        </p>

        <section class="context">
            <h2>Контекст эксперимента</h2>
            <p>
                В тестовой группе поменяли механику показа/плейсмент. Смотрим метрику RPM (или Revenue) по двум сегментам: Desktop и Touch.
            </p>
            <p>
                В каждом сегменте тест хуже контроля: Desktop −1.0%, Touch −0.5%.
            </p>
            <p>
                Но в агрегате (All users) тест лучше контроля: +0.6%.
            </p>
            <p>
                Эксперимент длился 14 дней, трафик стабильный, но доля сегментов в тесте и контроле различается.
            </p>
            <p>
                Вопрос: как такое возможно и как принимать решение?
            </p>
        </section>

        <div class="chart-block">
            <div class="chart-toolbar">
                <button id="mode-clean" onclick="toggleMode('clean')">Clean</button>
                <button id="mode-annotated" onclick="toggleMode('annotated')" class="active">Annotated</button>
            </div>

            <div class="chart-panel-title">Total (All users)</div>
            <div class="chart" id="chart-total"></div>

            <div class="chart-panel-title" style="margin-top: 3rem;">Desktop</div>
            <div class="chart" id="chart-desktop"></div>

            <div class="chart-panel-title" style="margin-top: 3rem;">Touch</div>
            <div class="chart" id="chart-touch"></div>
        </div>

        <section class="think-block">
            <h3>Подумай</h3>
            <ul>
                <li>Как такое возможно, если в каждом сегменте "минус", а в агрегате "плюс"?</li>
                <li>Что в первую очередь проверить: веса сегментов, состав трафика, mix shift?</li>
                <li>Как правильно принимать решение: по all, по сегментам или по целевой аудитории?</li>
                <li>Какие guardrails и риски нужно добавить, чтобы не "вкатить Simpson"?</li>
            </ul>
        </section>

        <details>
            <summary>Показать разбор</summary>

            <section class="analysis">
                <h3>Разбор</h3>

                <p>
                    На графике видно, что агрегатная метрика (All) показывает положительную дельту, в то время как каждый сегмент показывает отрицательную дельту. Это классический пример Simpson's paradox.
                </p>

                <p>
                    <strong>Simpson's paradox простыми словами:</strong> Агрегатная метрика — это взвешенная сумма по сегментам. "Плюс" в агрегате может появиться не из-за улучшения в сегментах, а из-за смены весов (доли Desktop/Touch) между тестом и контролем. Если в тесте больше доля "лучшего" сегмента, агрегат будет лучше, даже если каждый сегмент стал хуже.
                </p>

                <p>
                    <strong>Типовые причины конфликтов сегментов:</strong>
                </p>
                <ol>
                    <li><strong>Дисбаланс сплита (разные доли сегментов в тесте/контроле):</strong> Рандомизация не гарантирует одинаковые доли сегментов в тесте и контроле. Если в тесте случайно оказалось больше Desktop (который имеет более высокий RPM), агрегат будет выше, даже если Desktop в тесте хуже, чем Desktop в контроле.</li>
                    <li><strong>Mix shift по инвентарю/плейсментам внутри сегментов:</strong> Изменение механики показа привело к сдвигу микса инвентаря. Например, в Desktop стало больше высокоценных плейсментов, но их эффективность упала. В Touch стало меньше плейсментов, но их эффективность выросла. Агрегат маскирует эти сдвиги.</li>
                    <li><strong>Эффект есть только в узком сегменте, а агрегат маскирует:</strong> Эффект есть в небольшом подсегменте (например, мобильные девайсы с определённой версией ОС), но в агрегате Desktop/Touch этот эффект теряется на фоне остальных подсегментов.</li>
                </ol>

                <p>
                    <strong>Минимальный протокол:</strong>
                </p>
                <ol>
                    <li><strong>Сравнить доли сегментов тест/контроль (weights):</strong> Проверить, одинаковы ли доли Desktop и Touch в тесте и контроле. Если доли различаются — это первый признак проблемы.</li>
                    <li><strong>Посчитать агрегат как "reweighted" (перевзвесить сегменты на общий baseline):</strong> Выровнять веса сегментов между тестом и контролем. Например, взять общую долю Desktop из обеих групп и пересчитать агрегат. Если после reweight агрегат становится отрицательным — эффект был артефактом весов.</li>
                    <li><strong>Проверить, не вызван ли эффект сменой состава:</strong> Проверить mix shift внутри сегментов: изменился ли состав инвентаря, плейсментов, устройств. Возможно, эффект вызван не изменением механики, а сменой состава.</li>
                    <li><strong>Решение принимать по целевой аудитории / guardrails:</strong> Если сегменты показывают отрицательный эффект, а агрегат положительный из-за весов — решение должно быть "не катить", так как продукт ухудшился для целевой аудитории. Если после reweight эффект остаётся положительным — можно рассматривать выкат, но с проверкой guardrails.</li>
                </ol>

                <p>
                    <strong>Важно:</strong> "All users" без контроля состава — опасная метрика. Агрегатный эффект может маскировать реальные проблемы в сегментах или создавать ложное впечатление успеха.
                </p>
            </section>
        </details>

        <section class="conclusion">
            <h3>Вывод</h3>

            <div class="conclusion-section">
                <div class="conclusion-section-title">❌ Неправильный вывод:</div>
                <div class="conclusion-section-content">
                    «В агрегате плюс — значит катим. Все пользователи выиграли.»
                </div>
            </div>

            <div class="conclusion-section">
                <div class="conclusion-section-title">✅ Корректный вывод:</div>
                <div class="conclusion-section-content">
                    Агрегатный плюс (+0.6%) может быть артефактом весов сегментов, а не реальным улучшением. В каждом сегменте эффект отрицательный (Desktop −1.0%, Touch −0.5%), что указывает на ухудшение продукта для целевой аудитории. Нужно выровнять веса сегментов (reweight) и проверить состав трафика. Решение должно приниматься по целевым сегментам и после reweight: если после выравнивания весов эффект остаётся отрицательным — нельзя катить, так как продукт ухудшился для пользователей.
                </div>
            </div>

            <div class="conclusion-section">
                <div class="conclusion-section-title">⚠️ Чего нельзя утверждать:</div>
                <div class="conclusion-section-content">
                    Нельзя утверждать, что "продукт улучшился для всех" — в каждом сегменте эффект отрицательный. Нельзя утверждать, что "эффект причинный" без контроля состава — возможно, эффект вызван сменой весов, а не изменением механики. Нельзя утверждать, что "сегменты можно игнорировать" — агрегат без контроля состава маскирует реальные проблемы и может привести к выкату ухудшения.
                </div>
            </div>
        </section>

        <section class="related-topics">
            <h3>Связанные темы</h3>
            <ul>
                <li><a href="../../experiments/metrics-for-reading.html">Метрики для чтения эксперимента: разложение на сегменты</a></li>
                <li><a href="../../monetization/market/price-vs-volume.html">Price vs Volume: разложение на компоненты</a></li>
                <li><a href="../../monetization/metrics/metric-decomposition.html">Декомпозиция метрик: как разложить эффект</a></li>
                <li><a href="../../experiments/anatomy-of-experiment.html">Анатомия эксперимента: проверка сегментов</a></li>
            </ul>
        </section>

        <nav class="scenario-nav">
            <a href="./004-no-effect.html">← Предыдущий сценарий</a>
            <a href="../index.html">К практикуму</a>
            <a href="./006-window-changes-conclusion.html">Следующий сценарий →</a>
        </nav>
    </div>

    <script src="../assets/js/ab_charts.js"></script>
    <script>
        // Scenario 005: Simpson's paradox
        // Synthetic data: 14 days, baseline = 100
        // Total: Test > Control (+0.6%) - but this is due to weight shift
        // Desktop: Test < Control (-1.0%)
        // Touch: Test < Control (-0.5%)
        // Key: Different segment weights in test vs control create the illusion

        let currentMode = 'annotated';

        function generateData() {
            const days = Array.from({length: 15}, (_, i) => i);
            
            // Total: Test slightly higher (due to weight shift, not real improvement)
            const totalControl = days.map(d => ({ x: d, y: 100 + (Math.random() - 0.5) * 0.3 }));
            const totalTest = days.map(d => {
                const base = 100.6; // +0.6% (artifact of weights)
                const noise = (Math.random() - 0.5) * 0.3;
                return { x: d, y: base + noise };
            });

            // Desktop: Test worse
            const desktopControl = days.map(d => ({ x: d, y: 100 + (Math.random() - 0.5) * 0.3 }));
            const desktopTest = days.map(d => {
                const base = 99; // -1.0%
                const noise = (Math.random() - 0.5) * 0.3;
                return { x: d, y: base + noise };
            });

            // Touch: Test worse
            const touchControl = days.map(d => ({ x: d, y: 100 + (Math.random() - 0.5) * 0.3 }));
            const touchTest = days.map(d => {
                const base = 99.5; // -0.5%
                const noise = (Math.random() - 0.5) * 0.3;
                return { x: d, y: base + noise };
            });

            return { totalControl, totalTest, desktopControl, desktopTest, touchControl, touchTest };
        }

        function renderCharts() {
            const data = generateData();
            const annotationsEnabled = currentMode === 'annotated';

            // Total chart
            ABCharts.render({
                el: '#chart-total',
                series: [
                    { name: 'Control', values: data.totalControl, dashed: true, opacity: 0.6 },
                    { name: 'Test', values: data.totalTest, color: '#4a9eff' }
                ],
                axis: {
                    xLabel: 'Дни эксперимента',
                    yLabel: 'RPM (индекс)',
                    xTicks: 14,
                    yTicks: 5,
                    yFormat: d => d.toFixed(1)
                },
                annotations: {
                    enabled: annotationsEnabled,
                    labels: annotationsEnabled ? [
                        { x: 12, y: 100.7, text: '+0.6% (артефакт весов?)', color: '#960', fontSize: '11px', fontWeight: '500' }
                    ] : []
                },
                theme: {
                    background: '#ffffff',
                    grid: true
                },
                height: 300,
                responsive: true
            });

            // Desktop chart
            ABCharts.render({
                el: '#chart-desktop',
                series: [
                    { name: 'Control', values: data.desktopControl, dashed: true, opacity: 0.6 },
                    { name: 'Test', values: data.desktopTest, color: '#ff6b6b' }
                ],
                axis: {
                    xLabel: 'Дни эксперимента',
                    yLabel: 'RPM (индекс)',
                    xTicks: 14,
                    yTicks: 5,
                    yFormat: d => d.toFixed(1)
                },
                annotations: {
                    enabled: annotationsEnabled,
                    labels: annotationsEnabled ? [
                        { x: 12, y: 98.8, text: '-1.0%', color: '#ff6b6b', fontSize: '11px', fontWeight: '500' }
                    ] : []
                },
                theme: {
                    background: '#ffffff',
                    grid: true
                },
                height: 300,
                responsive: true
            });

            // Touch chart
            ABCharts.render({
                el: '#chart-touch',
                series: [
                    { name: 'Control', values: data.touchControl, dashed: true, opacity: 0.6 },
                    { name: 'Test', values: data.touchTest, color: '#ff6b6b' }
                ],
                axis: {
                    xLabel: 'Дни эксперимента',
                    yLabel: 'RPM (индекс)',
                    xTicks: 14,
                    yTicks: 5,
                    yFormat: d => d.toFixed(1)
                },
                annotations: {
                    enabled: annotationsEnabled,
                    labels: annotationsEnabled ? [
                        { x: 12, y: 99.3, text: '-0.5%', color: '#ff6b6b', fontSize: '11px', fontWeight: '500' }
                    ] : []
                },
                theme: {
                    background: '#ffffff',
                    grid: true
                },
                height: 300,
                responsive: true
            });
        }

        function toggleMode(mode) {
            currentMode = mode;
            document.getElementById('mode-clean').classList.toggle('active', mode === 'clean');
            document.getElementById('mode-annotated').classList.toggle('active', mode === 'annotated');
            renderCharts();
        }

        window.addEventListener('DOMContentLoaded', () => {
            renderCharts();
        });
    </script>
</body>
</html>
