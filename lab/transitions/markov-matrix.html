<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transitions (Markov Matrix)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background-color: #ffffff;
            padding: 3rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1rem;
            font-weight: 400;
            color: #666;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .caption {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 3rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 2rem;
            color: #666;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: #1a1a1a;
        }

        .chart-container {
            margin-top: 3rem;
            background: #ffffff;
            padding: 2.5rem;
        }

        .cell {
            stroke: #fff;
            stroke-width: 0.5;
            cursor: pointer;
            transition: stroke-width 0.2s ease;
        }

        .cell:hover {
            stroke-width: 1.5;
        }

        .axis-label {
            font-size: 10px;
            fill: #999;
            font-weight: 400;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Transitions</a>
        <h1>Transitions (Markov Matrix)</h1>
        <p class="subtitle">Memoryless dynamics. Structured motion.</p>
        <p class="caption">A two-regime chain with higher probability to stay near current state.</p>

        <div class="chart-container">
            <svg id="chart"></svg>
        </div>
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // States: 1..20
        const nStates = 20;
        const states = Array.from({ length: nStates }, (_, i) => i + 1);

        // Build transition matrix
        const matrix = [];
        for (let i = 0; i < nStates; i++) {
            const row = new Array(nStates).fill(0);
            const state = i + 1;

            // Local transitions: i-1, i, i+1 with weights (0.25, 0.5, 0.25)
            if (state > 1) {
                row[i - 1] = 0.25; // to i-1
            }
            row[i] = 0.5; // stay at i
            if (state < nStates) {
                row[i + 1] = 0.25; // to i+1
            }

            // Add small probability jumps to state 1 and state 20
            row[0] += 0.02; // to state 1
            row[nStates - 1] += 0.02; // to state 20

            // Renormalize row
            const rowSum = row.reduce((a, b) => a + b, 0);
            for (let j = 0; j < nStates; j++) {
                row[j] = row[j] / rowSum;
            }

            matrix.push(row);
        }

        // Set up dimensions
        const cellSize = 35;
        const margin = { top: 50, right: 30, bottom: 50, left: 50 };
        const width = nStates * cellSize + margin.left + margin.right;
        const height = nStates * cellSize + margin.top + margin.bottom;

        // Create SVG
        const svg = d3.select("#chart")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Color scale - single color intensity
        const maxProb = d3.max(matrix.flat());
        const colorScale = d3.scaleSequential(d3.interpolateGreys)
            .domain([0, maxProb]);

        // Create scales
        const xScale = d3.scaleBand()
            .domain(states)
            .range([0, nStates * cellSize])
            .padding(0.05);

        const yScale = d3.scaleBand()
            .domain(states)
            .range([0, nStates * cellSize])
            .padding(0.05);

        // Create tooltip
        const tooltip = d3.select("#tooltip");

        // Create cells
        const cells = [];
        for (let i = 0; i < nStates; i++) {
            for (let j = 0; j < nStates; j++) {
                cells.push({
                    from: i + 1,
                    to: j + 1,
                    prob: matrix[i][j]
                });
            }
        }

        g.selectAll(".cell")
            .data(cells)
            .enter()
            .append("rect")
            .attr("class", "cell")
            .attr("x", d => xScale(d.to))
            .attr("y", d => yScale(d.from))
            .attr("width", xScale.bandwidth())
            .attr("height", yScale.bandwidth())
            .attr("fill", d => colorScale(d.prob))
            .on("mouseover", function(event, d) {
                tooltip
                    .style("opacity", 1)
                    .html(`from ${d.from} → to ${d.to}: p=${d.prob.toFixed(3)}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mousemove", function(event) {
                tooltip
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function() {
                tooltip.style("opacity", 0);
            });

        // Add row labels (from-state) - show at 1, 5, 10, 15, 20
        const rowLabelStates = [1, 5, 10, 15, 20];
        g.selectAll(".row-label")
            .data(rowLabelStates)
            .enter()
            .append("text")
            .attr("class", "axis-label")
            .attr("x", -10)
            .attr("y", d => yScale(d) + yScale.bandwidth() / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "end")
            .text(d => d);

        // Add column labels (to-state) - show at 1, 5, 10, 15, 20
        g.selectAll(".col-label")
            .data(rowLabelStates)
            .enter()
            .append("text")
            .attr("class", "axis-label")
            .attr("x", d => xScale(d) + xScale.bandwidth() / 2)
            .attr("y", nStates * cellSize + 20)
            .attr("text-anchor", "middle")
            .text(d => d);
    </script>
</body>
</html>

