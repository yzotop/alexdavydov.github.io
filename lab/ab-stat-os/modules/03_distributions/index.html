<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Модуль 3. Распределения — Статистика A/B-тестирования</title>
    <link rel="stylesheet" href="../../assets/style.css">
</head>
<body>
    <div class="container">
        <div class="breadcrumbs">
            <a href="../../../../courses/index.html">Все курсы</a> /
            <a href="../../index.html">Статистика A/B-тестирования</a> / Модуль 3
        </div>

        <div class="nav-links">
            <a href="./index.html" class="active">Модуль</a>
            <a href="./practice.html">Практика</a>
            <a href="./simulators.html">Симуляторы</a>
        </div>

        <h1>Модуль 3. Распределения</h1>

        <!-- Section 1 -->
        <section class="section">
            <h2>1. Зачем распределения в A/B: что ломается, если их игнорировать</h2>

            <h3>«Среднее» не всегда отражает продукт</h3>
            <p>
                Revenue per user: среднее = 120₽. Но 80% пользователей = 0₽, 15% = 50–200₽, 5% = 500–10 000₽.
                Среднее описывает «типичного пользователя», которого не существует. Решение на основе разницы средних —
                решение на основе абстракции.
            </p>
            <p>
                Число сессий: среднее = 4.2. Но медиана = 2, мода = 1, а один пользователь с 500 сессиями сдвигает среднее
                всей группы. t-test сравнивает средние — но если среднее нестабильно, p-value тоже нестабилен.
            </p>

            <h3>Как распределение влияет на статтест и power</h3>
            <p>Каждый статтест делает допущения о данных. t-test предполагает, что среднее имеет нормальное распределение (CLT). Это работает при:</p>
            <ul>
                <li>достаточном N (тысячи, не десятки)</li>
                <li>конечной дисперсии</li>
                <li>отсутствии экстремальных выбросов</li>
            </ul>
            <p>
                Если эти условия нарушены — CLT сходится медленно. p-value «плывёт»: один запуск даёт 0.03, повторный — 0.45.
                Power analysis обещает 80%, реальная power — 30%.
            </p>
            <p><strong>Вывод:</strong> прежде чем выбирать тест — посмотрите на данные. Не на среднее, а на форму.</p>
        </section>

        <!-- Section 2 -->
        <section class="section">
            <h2>2. Типовые формы продуктовых данных</h2>

            <h3>Доля (Bernoulli / Binomial)</h3>
            <p>Каждая единица — 0 или 1. Агрегированная доля — биномиальная.</p>
            <p><strong>Примеры:</strong> CR (купил / не купил), CTR (кликнул / не кликнул), retention (вернулся / нет).</p>
            <p><strong>Свойства:</strong> дисперсия = p(1−p)/n. Максимальна при p = 0.5, минимальна при крайних значениях. CLT работает быстро — z-test надёжен уже при n &gt; 1000 (если p не слишком близко к 0 или 1).</p>
            <p><strong>Когда ломается:</strong> при p &lt; 0.01 или p &gt; 0.99 нормальная аппроксимация плоха. Нужен точный тест Фишера или bootstrap.</p>

            <h3>Счётчики (Poisson / Negative Binomial)</h3>
            <p>Число дискретных событий за период. Целые неотрицательные значения.</p>
            <p><strong>Примеры:</strong> число заказов за неделю, число сессий за день, число кликов по рекомендациям.</p>
            <p><strong>Свойства:</strong> Poisson: среднее = дисперсия. В реальности дисперсия обычно больше (overdispersion) → Negative Binomial. Правый хвост, асимметрия. Zero inflation частая — большая масса в нуле.</p>
            <p><strong>Практическое следствие:</strong> t-test на счётчиках формально работает (CLT), но при большой overdispersion среднее нестабильно. При zero inflation стоит разделить метрику: конверсия (0/1) + среднее среди активных.</p>

            <h3>Время (Exponential / Weibull, heavy right tail)</h3>
            <p>Время до события: всегда положительное, часто с длинным правым хвостом.</p>
            <p><strong>Примеры:</strong> время до первой покупки, время загрузки страницы, время доставки, time-to-resolution в support.</p>
            <p><strong>Свойства:</strong> сильная правая асимметрия. Медиана &lt;&lt; среднего. Несколько «застрявших» кейсов (доставка через 2 недели вместо 2 часов) драматически сдвигают среднее.</p>
            <p><strong>Практическое следствие:</strong> t-test на средних — рискованно. Winsorization (ограничить максимум) или log-трансформация. Bootstrap предпочтительнее.</p>

            <h3>Деньги (Log-normal / Pareto-like, смесь)</h3>
            <p>Revenue, GMV, LTV, средний чек. Положительные, с тяжёлым правым хвостом.</p>
            <p><strong>Примеры:</strong> revenue per user, GMV per user, LTV 90 дней.</p>
            <p><strong>Свойства:</strong> часто хорошо аппроксимируются log-normal (в логарифме — нормальные). Но хвост может быть ещё тяжелее (Pareto-like): 1% пользователей = 40% выручки. Это не outlier — это структура рынка.</p>
            <p><strong>Практическое следствие:</strong> среднее определяется хвостом. t-test зависит от нескольких наблюдений. Bootstrap, trimmed mean, winsorization — обязательны. Log-трансформация работает, но меняет интерпретацию (вы тестируете геометрическое среднее, а не арифметическое).</p>

            <h3>Нулевая инфляция (Zero-inflated)</h3>
            <p>Большая масса в нуле + непрерывное или дискретное распределение для ненулевых.</p>
            <p><strong>Примеры:</strong> purchases per user (80% = 0), revenue per user, число рефералов.</p>
            <p><strong>Свойства:</strong> двухкомпонентная смесь: (1) «нулевой процесс» (пользователь не конвертировался) + (2) «ненулевой процесс» (распределение среди конвертировавших). Среднее близко к нулю, медиана = 0, дисперсия завышена.</p>
            <p><strong>Практическое следствие:</strong> мощность t-test резко падает. Разделение на CR (proportion) + среднее среди конвертировавших — проще и мощнее. CUPED с pre-period помогает (снижает дисперсию на 30–50%).</p>

            <h3>Смешанные распределения (Mixtures)</h3>
            <p>Данные — смесь нескольких подпопуляций.</p>
            <p><strong>Примеры:</strong> время в приложении (active users vs passive), revenue (freemium vs premium), latency (cache hit vs miss).</p>
            <p><strong>Свойства:</strong> бимодальные или мультимодальные гистограммы. Среднее не описывает ни одну из подгрупп. Дисперсия завышена.</p>
            <p><strong>Практическое следствие:</strong> если treatment по-разному влияет на подгруппы — средний эффект маскирует гетерогенность. Стоит стратифицировать анализ или использовать quantile-методы.</p>
        </section>

        <!-- Section 3 -->
        <section class="section">
            <h2>3. Диагностика: как понять форму без формул</h2>

            <h3>Симптомы heavy tail</h3>
            <ul>
                <li>Среднее &gt;&gt; медианы (отношение &gt;1.5–2×)</li>
                <li>Топ-1% наблюдений содержит &gt;10% от суммы</li>
                <li>При удалении 10 наблюдений среднее меняется &gt;5%</li>
                <li>t-test даёт разные результаты при повторных запусках (нестабильный p-value)</li>
            </ul>

            <h3>Симптомы zero inflation</h3>
            <ul>
                <li>Медиана = 0</li>
                <li>Мода = 0</li>
                <li>Более 50% наблюдений = 0</li>
                <li>Гистограмма: огромный столбец в нуле, затем «хвост» ненулевых</li>
            </ul>

            <h3>Skewness, outliers, long tail</h3>
            <ul>
                <li>Skewness &gt; 2 → сильная правая асимметрия → t-test рискован</li>
                <li>Outliers: точки, далёкие от Q3 + 1.5·IQR → проверить, это ошибка или структура данных</li>
                <li>Если outliers — структура (whale users в revenue) → winsorization/bootstrap, не удаление</li>
            </ul>

            <h3>Что смотреть: графическая диагностика</h3>
            <ol>
                <li><strong>Гистограмма</strong> — форма, модальность, масса в нуле</li>
                <li><strong>Гистограмма в log-шкале</strong> — если после логарифма данные похожи на колокол → log-normal</li>
                <li><strong>Q-Q plot</strong> — отклонение от прямой в хвостах → heavy tail</li>
                <li><strong>Box plot</strong> — медиана, IQR, whiskers, outliers</li>
            </ol>
            <p>
                Формулы не нужны. Достаточно посмотреть на гистограмму и ответить на 3 вопроса:
            </p>
            <ul>
                <li>Есть ли масса в нуле?</li>
                <li>Есть ли тяжёлый правый хвост?</li>
                <li>Похоже ли на смесь (&gt;1 моды)?</li>
            </ul>
        </section>

        <!-- Section 4 -->
        <section class="section">
            <h2>4. Практические последствия для A/B</h2>

            <h3>Почему t-test часто «живёт», но иногда врёт</h3>
            <p>CLT гарантирует, что среднее стремится к нормальному распределению при N → ∞. На практике:</p>
            <ul>
                <li>Для пропорций (Bernoulli): N &gt; 1000 обычно достаточно</li>
                <li>Для лёгких хвостов (Poisson, counts): N &gt; 5000</li>
                <li>Для денежных метрик (log-normal): N &gt; 10 000–50 000</li>
                <li>Для heavy tail (Pareto-like): CLT может сходиться <em>очень</em> медленно — десятки тысяч недостаточно</li>
            </ul>
            <p>
                «t-test живёт» значит: при повторных запусках p-value стабилен. «Врёт» значит: один запуск — p = 0.02, другой — p = 0.6.
                Если ваша метрика в heavy tail зоне, увеличение выборки помогает, но медленно.
            </p>

            <h3>Когда bootstrap предпочтительнее</h3>
            <ul>
                <li>Heavy tail (revenue, GMV, LTV)</li>
                <li>Малая выборка (&lt;5K на группу)</li>
                <li>Ratio-метрики (bootstrap отношения проще, чем delta-method)</li>
                <li>Когда нет уверенности в форме распределения (unknown shape)</li>
            </ul>
            <p>Bootstrap не «лучше» t-test — он робастнее. При лёгких хвостах t-test точнее и дешевле.</p>

            <h3>Когда log-трансформация уместна</h3>
            <ul>
                <li>Данные положительные и правоскошенные</li>
                <li>В log-шкале — приблизительно нормальные (log-normal)</li>
                <li>Вы готовы интерпретировать результат как <em>отношение</em> средних (geometric mean ratio), а не <em>разность</em></li>
            </ul>
            <div class="callout callout-warn">
                <p><strong>Риск:</strong> log(0) не определён. При zero inflation нужен log(x + 1) (log1p) — но это искажает распределение и ослабляет эффект. Не рекомендуется при &gt;30% нулей.</p>
            </div>

            <h3>Когда winsorization / trimming — и какие риски</h3>
            <p>
                <strong>Winsorization</strong> — замена значений выше P99 (или P95) на пороговое. Сохраняет наблюдения, снижает влияние хвоста.
            </p>
            <p>
                <strong>Trimming</strong> — удаление крайних значений. Теряем данные, но среднее стабильнее.
            </p>
            <p><strong>Риски:</strong> (1) Если treatment влияет на хвост (например, увеличивает число whale users) — winsorization скрывает реальный эффект. (2) Порог (P95 vs P99) — произвольный. Разные пороги дают разные p-value.</p>
            <p><strong>Рекомендация:</strong> зафиксировать порог <em>до</em> эксперимента. Показывать результат с winsorization и без — как sensitivity check.</p>

            <h3>Ratio-метрики: отдельная опасность</h3>
            <p>
                AOV = GMV / orders. И числитель, и знаменатель — случайные величины. Распределение отношения — не log-normal и не нормальное,
                даже если каждый компонент по отдельности «нормальный».
            </p>
            <p><strong>Следствие:</strong> ни t-test на средних AOV, ни log-трансформация не корректны. Нужен delta-method (линеаризация) или bootstrap отношения.</p>
            <p>Подробнее — Модуль 02 (типы метрик) и Модуль 04 (выбор теста).</p>
        </section>

        <!-- Section 5 -->
        <section class="section">
            <h2>5. Мостик к выбору теста</h2>
            <table>
                <thead>
                    <tr>
                        <th>Форма данных</th>
                        <th>Риск</th>
                        <th>Рекомендованный подход</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Бинарная (0/1)</td>
                        <td>Минимальный при p ∈ [0.01, 0.99]</td>
                        <td>z-test для долей</td>
                    </tr>
                    <tr>
                        <td>Счётчики (Poisson-like)</td>
                        <td>Overdispersion, zero inflation</td>
                        <td>t-test (с осторожностью) / bootstrap</td>
                    </tr>
                    <tr>
                        <td>Время (right tail)</td>
                        <td>Heavy tail, нестабильное среднее</td>
                        <td>Bootstrap / winsorization</td>
                    </tr>
                    <tr>
                        <td>Деньги (log-normal)</td>
                        <td>Heavy tail, extreme outliers</td>
                        <td>Bootstrap / trimmed mean / log1p (если мало нулей)</td>
                    </tr>
                    <tr>
                        <td>Zero-inflated</td>
                        <td>Потеря power</td>
                        <td>Разделить на CR + среднее среди ненулевых</td>
                    </tr>
                    <tr>
                        <td>Ratio</td>
                        <td>Ковариация числителя/знаменателя</td>
                        <td>Delta-method / bootstrap отношения</td>
                    </tr>
                    <tr>
                        <td>Mixture</td>
                        <td>Гетерогенность эффекта</td>
                        <td>Стратификация / quantile-методы</td>
                    </tr>
                </tbody>
            </table>
            <div class="learn-block">
                <h3>Мостик к следующему модулю</h3>
                <p>
                    Следующий шаг: используйте симулятор распределений, чтобы увидеть, как форма данных влияет на рекомендацию.
                    Затем — Модуль 04 (Карта выбора статкритерия) для полного decision tree.
                </p>
            </div>
        </section>

        <!-- Preview sections -->
        <section class="preview-section">
            <h2>Практика</h2>
            <ul class="preview-list">
                <li>13 задач на распознавание форм распределений</li>
                <li>Диагностика heavy tail, zero inflation, смесей и outliers</li>
                <li>Связь формы распределения с выбором статтеста и мощностью</li>
            </ul>
            <a href="./practice.html" class="nav-card">Открыть практику</a>
        </section>

        <section class="preview-section">
            <h2>Симуляторы</h2>
            <ul class="preview-list">
                <li>Distribution Playground — визуализация распределений и их влияния на A/B-тест</li>
            </ul>
            <a href="./simulators.html" class="nav-card">Открыть симуляторы</a>
        </section>

        <nav class="module-nav">
            <a href="../02_metric_types/index.html">← Предыдущий модуль</a>
            <a href="../../index.html">К курсу</a>
            <a href="../04_stat_tests_map/index.html">Следующий модуль →</a>
        </nav>
    </div>
</body>
</html>

