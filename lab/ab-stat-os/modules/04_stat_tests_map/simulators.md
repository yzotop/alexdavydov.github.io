# Симулятор — Карта выбора статкритерия

**Файл:** `simulators/test_selection_map/index.html`

## Как использовать

1. Откройте симулятор в браузере.
2. Выберите готовый сценарий из выпадающего списка — поля заполнятся автоматически.
3. Или задайте параметры вручную: тип метрики + 5 чекбоксов.
4. Нажмите **«Подобрать тест»**.
5. Изучите результат: основной критерий, снижение дисперсии, кластерная поправка, допущения, предупреждения.

## Что означают входы

| Параметр | Что задаёт |
|---|---|
| **Тип метрики** | Основная ветвь дерева решений: доля, per-user, ratio, conditional |
| **Heavy tail** | Распределение с тяжёлыми хвостами (revenue, GMV). Влияет на выбор между t-test и bootstrap |
| **Zero inflation** | Много нулей (пользователи без событий). Влияет на предупреждения и рекомендацию разделить метрику |
| **Кластерная рандомизация** | Рандомизация по гео/командам. Включает cluster-robust SE и предупреждение о малом числе кластеров |
| **Pre-period данные** | Наличие ковариаты до эксперимента. Включает рекомендацию CUPED |
| **Большая выборка** | >10K на группу. Влияет на выбор между точными тестами и аппроксимациями |

## Что означают выходы

- **Основной критерий** — конкретный тест или семейство тестов с объяснением
- **Снижение дисперсии** — появляется, если доступен CUPED (pre-period отмечен)
- **Кластерная поправка** — появляется при кластерной рандомизации
- **Допущения** — цветовые метки: ✓ выполнено (зелёный), ✗ нарушено (красный), ? неизвестно (синий)
- **Предупреждения** — максимум 3, отсортированы по критичности (danger → warning)
- **Объяснение** — 1–2 абзаца с обоснованием рекомендации

## Разбор 8 пресетов

### 1. CR (конверсия), большая выборка

**Параметры:** proportion, large_n = true.
**Результат:** z-test / chi-square.
**На что обратить внимание:** самый простой случай. Все допущения выполнены. Нет предупреждений. Это baseline — от него строится дерево вниз.

### 2. Revenue per user, heavy tail

**Параметры:** per_user, heavy_tail = true, zero_inflation = true.
**Результат:** Bootstrap / trimmed mean / winsorization.
**На что обратить внимание:** два предупреждения — heavy tail и zero inflation. t-test формально работает, но нестабилен. Появляется рекомендация разделить метрику.

### 3. AOV (ratio), стандартная выборка

**Параметры:** ratio, всё остальное false.
**Результат:** Bootstrap отношения (малая выборка, delta-method ненадёжен).
**На что обратить внимание:** предупреждение о гетерогенности знаменателя. Допущение «знаменатель > 0» помечено как неизвестное (?).

### 4. Гео-кластерный эксперимент

**Параметры:** per_user, cluster = true.
**Результат:** t-test + cluster-robust SE.
**На что обратить внимание:** появляется отдельный блок «Кластерная поправка». Предупреждение о малом числе кластеров. Допущение «независимость наблюдений» помечено как неизвестное.

### 5. ARPPU (conditional), с pre-period

**Параметры:** conditional, heavy_tail = true, pre_period = true.
**Результат:** Двухэтапная процедура / регрессия.
**На что обратить внимание:** допущение «подвыборка не зависит от treatment» помечено как нарушенное (✗). CUPED появляется, но с оговоркой — conditional-метрика делает ковариату ненадёжной. Два предупреждения: selection bias + CUPED limitations.

### 6. CTR (proportion), большая выборка

**Параметры:** proportion, large_n = true.
**Результат:** z-test / chi-square.
**На что обратить внимание:** идентичен пресету 1 (CR). Это потому, что CTR — тоже доля (каждый показ → бинарный исход). Различия появятся, если добавить cluster или treatment-affected exposure (в текущей модели — через отдельные чекбоксы).

### 7. Revenue + CUPED (pre-period)

**Параметры:** per_user, heavy_tail = true, zero_inflation = true, pre_period = true.
**Результат:** Bootstrap + CUPED.
**На что обратить внимание:** сравните с пресетом 2. Единственная разница — pre_period. Появляется блок «Снижение дисперсии» с CUPED. Дополнительное допущение: «pre-period стабилен (нет дрейфа)».

### 8. Ratio, малая выборка, heavy tail

**Параметры:** ratio, heavy_tail = true.
**Результат:** Bootstrap отношения.
**На что обратить внимание:** сравните с пресетом 3. Добавился heavy tail → та же рекомендация (bootstrap), но с дополнительным предупреждением о heavy tail. Delta-method явно исключён как ненадёжный.

## Общий паттерн

При переключении пресетов обратите внимание:

1. Базовый случай (proportion + large) → z-test. Каждое усложнение (heavy tail, cluster, conditional) двигает рекомендацию к более робастным методам.
2. CUPED появляется как дополнение к основному тесту, а не замена. Это variance reduction, не другой критерий.
3. Cluster-robust SE — тоже поправка, а не тест. Основной тест остаётся тем же, но SE пересчитываются.
4. Conditional — единственный тип, где нужен принципиально другой подход (двухэтапная процедура), а не модификация стандартного.
