# Симулятор — Cluster Simulator

**Файл:** [`simulators/cluster_simulator/index.html`](../../simulators/cluster_simulator/index.html)

## Что делает симулятор

Cluster Simulator генерирует синтетические данные кластерного A/B-теста и показывает, как ICC и размер кластера раздувают дисперсию. Вы задаёте параметры — симулятор рассчитывает naive и cluster-adjusted p-value, визуализирует разницу SE и отображает средние кластеров.

## Как использовать

1. Настройте: число кластеров, размер кластера, ICC, эффект.
2. Нажмите **«Симулировать»**.
3. Сравните naive p-value (user-level) и cluster p-value (cluster-level).
4. Меняйте ICC — наблюдайте, как Design Effect поглощает power.

## Что означают выходы

| Показатель | Что отражает |
|---|---|
| **Design Effect** | Во сколько раз кластерная структура «раздувает» дисперсию |
| **n effective** | Реальное число независимых наблюдений (n / DEFF) |
| **Naive p-value** | P-value при игнорировании кластеров (часто ложно-значимый) |
| **Cluster p-value** | P-value с учётом кластерной структуры |
| **SE inflation** | Во сколько раз cluster SE больше naive SE |
| **Type I (naive)** | Реальная вероятность ложного срабатывания наивного теста |

## Три миссии

### Миссия 1: Увидеть инфляцию Type I error

1. Установите k = 15, m = 1 000, ICC = 0.020, lift = 0%.
2. Нажмите «Симулировать». Naive p-value может быть < 0.05 (ложное срабатывание).
3. Cluster p-value — корректный (обычно > 0.05).
4. Посмотрите Type I (naive) — это реальный FPR при использовании user-level теста.
5. **Вывод:** наивный тест на кластерных данных обманывает.

### Миссия 2: Увидеть, как ICC уничтожает power

1. Установите k = 10, m = 2 000, lift = 5%.
2. ICC = 0.001 → DEFF ≈ 3, cluster p-value может быть значим.
3. ICC = 0.010 → DEFF ≈ 21, cluster p-value > 0.05. Эффект не виден.
4. ICC = 0.050 → DEFF ≈ 101, n_eff = несколько сотен. Безнадёжно.
5. **Вывод:** даже маленький ICC при больших кластерах убивает power.

### Миссия 3: Число кластеров vs размер кластера

1. Установите ICC = 0.010, lift = 5%.
2. k = 10, m = 5 000 → n_total = 100K, DEFF ≈ 51, n_eff ≈ 2 000.
3. k = 50, m = 1 000 → n_total = 100K, DEFF ≈ 11, n_eff ≈ 9 000.
4. **Вывод:** при том же бюджете пользователей — больше кластеров (меньшего размера) всегда лучше, чем меньше кластеров (большего размера).

## Связь с лекцией

- Секция 3 (ICC): симулятор визуализирует, как ICC определяет DEFF
- Секция 4 (Design Effect): формула DEFF = 1 + (m−1)·ICC в действии
- Секция 5 (Cluster-robust): разница naive vs cluster SE видна на графике
- Секция 2 (unit mismatch): наглядно: naive тест «видит» 100K пользователей, а реальных наблюдений — 20 кластеров
