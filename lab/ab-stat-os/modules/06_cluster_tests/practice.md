# Практика — Кластерные эксперименты

Для каждой задачи:
- Определите ошибку или рассчитайте показатель
- Обоснуйте ответ

Ответы — после каждой задачи.

---

## Задача 1. Наивный t-test на гео-данных

**Ситуация:** Сервис такси тестирует динамическое ценообразование. 16 городов рандомизированы (8 test, 8 control). В каждом городе ~100 000 поездок. Аналитик запускает t-test на уровне поездок → p = 0.003. Вывод: «эффект значимый».

### Ответ

**Ошибка:** единица рандомизации — город (16 городов), единица анализа — поездка (1.6M). T-test считает, что N = 800 000 на группу, но реальных независимых наблюдений — 8 на группу. SE занижена в десятки раз, p-value невалиден.

**Правильный подход:** агрегировать до уровня города (среднее revenue per trip по городу), затем t-test на 8 vs 8. Или: cluster-robust SE, но при 16 кластерах — осторожно.

**Type I error без коррекции:** при ICC = 0.01 и m = 100K → DEFF ≈ 1000 → реальный p ≈ 0.3–0.5 (не 0.003).

---

## Задача 2. Рассчитать Design Effect

**Дано:** 30 магазинов. Средний размер магазина m = 2 000 покупателей/неделю. ICC = 0.02.

### Ответ

**DEFF = 1 + (m − 1) × ICC = 1 + 1999 × 0.02 = 40.98 ≈ 41**

Каждый «реальный» покупатель эквивалентен 1/41 независимого наблюдения. 30 магазинов × 2000 = 60 000 покупателей → n_eff = 60 000 / 41 ≈ 1 463.

Это примерно равно числу кластеров × среднее: 30 × (2000 / 41) ≈ 30 × 49 ≈ 1 463. Интуиция: при высоком DEFF эффективная выборка определяется числом кластеров, а не числом пользователей.

---

## Задача 3. Effective sample size — сколько городов нужно?

**Дано:** Команда хочет MDE = 5% (конверсия ≈ 10%). Для user-level t-test нужно ~6 400 пользователей на группу (α = 0.05, power = 0.8). ICC = 0.005, m = 50 000 (пользователей на город).

**Вопрос:** сколько городов нужно в каждой группе?

### Ответ

DEFF = 1 + (50 000 − 1) × 0.005 = 251.

n_eff нужен = 6 400 на группу.
n_total на группу = n_eff × DEFF = 6 400 × 251 = 1 606 400.
Число городов = n_total / m = 1 606 400 / 50 000 ≈ 32.

**Нужно ~32 города на группу (64 всего).** Если доступно только 20 городов — MDE ≈ 5% × √(64 / 20) ≈ 9%. Детектировать 5% эффект невозможно.

**Альтернатива:** использовать CUPED (if pre-period correlation reduces variance) или выбрать метрику с более низким ICC.

---

## Задача 4. ICC = 0 — можно ли игнорировать кластеры?

**Ситуация:** A/B-тест на рекомендательном сервисе. Рандомизация по регионам (формально — кластерная). Но ICC оценён из исторических данных как ≈ 0.0002. Размер кластера m = 5 000.

### Ответ

DEFF = 1 + 4999 × 0.0002 = 2.0. Дисперсия увеличивается в 2 раза.

Хотя ICC кажется «нулевым» (0.0002), при больших кластерах (m = 5 000) design effect = 2. Это эквивалентно потере половины выборки.

**Вывод:** ICC нельзя игнорировать, если m × ICC > 0.1. Даже «микроскопический» ICC при больших кластерах создаёт значимый design effect.

---

## Задача 5. Курьерские зоны — выбор единицы рандомизации

**Ситуация:** Маркетплейс тестирует бонус курьерам за скорость. Три варианта рандомизации:
- (A) Пользователь: каждый заказчик случайно попадает в test/control
- (B) Курьер: каждый курьер назначается в test/control
- (C) Зона доставки: вся зона целиком в test или control

### Ответ

**(A) Пользователь** — неправильно. Бонус получает курьер, а не заказчик. Рандомизация пользователя не определяет, какой курьер доставит заказ.

**(B) Курьер** — опасно. В одной зоне бонусные курьеры будут забирать заказы быстрее, оставляя меньше заказов небонусным → interference (нарушение SUTVA). Эффект: бонусные курьеры «крадут» заказы, а не ускоряются.

**(C) Зона** — правильно. Все курьеры в зоне получают одинаковое treatment → нет interference внутри зоны. Но N_clusters меньше → нужно больше зон или больший эффект.

**Ответ: (C).** Цена — потеря power (меньше независимых наблюдений). Но без этого оценка эффекта невалидна.

---

## Задача 6. Гетерогенные кластеры — взвешивание

**Ситуация:** 24 магазина (12 test, 12 control). Размеры магазинов: от 500 до 50 000 покупателей. Аналитик агрегировал до уровня магазина и взял невзвешенный t-test на средних.

**Проблема?**

### Ответ

**Проблема:** невзвешенный t-test на агрегатах даёт каждому магазину одинаковый вес. Магазин с 500 покупателями и магазин с 50 000 — одинаково влияют на оценку ATE.

Это корректно для **cluster-level ATE** (эффект на средний кластер). Но если цель — **user-level ATE** (эффект на среднего пользователя) — нужно взвесить по размеру кластера.

**Рекомендация:** (1) взвешенный t-test (вес = n_j / Σn_j). (2) Или: cluster-robust SE на user-level данных. (3) Показать оба результата — если расходятся, обсудить причину (крупные магазины = другая аудитория).

---

## Задача 7. Spillover в социальной сети ⚠

**Ситуация:** Соцсеть тестирует новый формат сторис. Рандомизация user-level. Метрика: число просмотров сторис. Результат: +15%, p < 0.001. Но: пользователи видят сторис друзей. Если друг в тест-группе — его сторис в новом формате видят и control-пользователи.

### Ответ

**Проблема:** spillover. Treatment «утекает» из test в control через социальный граф. Control-пользователи тоже видят новый формат (через сторис друзей) → их метрика тоже растёт.

**Следствие:** оценка +15% — это нижняя граница реального эффекта. Реальный эффект может быть +25%, но 10% «утекло» в control.

**Диагностика:** проверить корреляцию между долей друзей в тест-группе и outcome в control. Если корреляция значимая — spillover подтверждён.

**Решение:** (1) Кластерная рандомизация по connected components или ego-networks. (2) Или: рандомизировать по городам. (3) Или: использовать модели с interference (сложно, но возможно).

---

## Задача 8. Рассчитать inflation factor

**Дано:** 40 кластеров (20+20). m = 1 000. ICC = 0.03. Аналитик считает user-level t-test → SE_naive. Насколько занижена SE?

### Ответ

DEFF = 1 + 999 × 0.03 = 30.97 ≈ 31.

SE_naive ∝ σ / √n, где n = 20 000.
SE_cluster ∝ σ / √(n / DEFF) = σ / √(20 000 / 31) = σ / √645.

**Inflation factor:** SE_cluster / SE_naive = √DEFF = √31 ≈ 5.6×.

Наивная SE занижена в 5.6 раз. P-value, рассчитанный наивно, соответствует z-statistic, завышенному в 5.6 раз. Если наивный z = 2.5 (p = 0.012) → реальный z = 2.5 / 5.6 = 0.45 (p = 0.65). Результат ничтожен.

---

## Задача 9. Pre-period estimation of ICC

**Ситуация:** Команда планирует гео-эксперимент. Как оценить ICC до запуска?

### Ответ

**Метод:** использовать исторические данные (pre-period).

1. Взять метрику за 2–4 недели по тем же кластерам.
2. Однофакторный ANOVA: SSB (between clusters) и SSW (within clusters).
3. ICC = (MSB − MSW) / (MSB + (m − 1) × MSW), где MSB = SSB / (k−1), MSW = SSW / (N−k).

**Упрощение:** если есть pandas/R — `lme4::ICC()` или `pingouin.intraclass_corr()`.

**Предупреждение:** ICC может отличаться pre vs post (например, если treatment усиливает между-кластерную дисперсию). Оценка из pre-period — нижняя граница.

---

## Задача 10. Школьный эксперимент — неправильная агрегация ⚠

**Ситуация:** Edtech-платформа тестирует новый курс. 50 классов (25 test, 25 control), по 30 учеников. Аналитик рассчитал средний балл каждого ученика → t-test на 750 vs 750 → p = 0.04.

Затем руководитель попросил «проверить на уровне классов» → t-test на 25 vs 25 → p = 0.18. Какой результат верный?

### Ответ

**Верный результат: p = 0.18** (уровень классов). Рандомизация по классам → анализ должен учитывать кластерную структуру.

DEFF = 1 + 29 × ICC. Если p сменился с 0.04 на 0.18 — это означает, что наивная SE была занижена. Разница z-scores: наивный z ≈ 2.05, кластерный z ≈ 1.34. Inflation ≈ 1.53 → DEFF ≈ 2.3 → ICC ≈ 0.045. Это типичное значение для учебных данных.

**Вывод:** при ICC ≈ 0.05 и m = 30 → DEFF ≈ 2.5. Наивный тест завышает значимость.

---

## Задача 11. Мало кластеров — что делать? ⚠

**Ситуация:** Компания работает в 8 регионах. Хотят тестировать новую логистику. 4 региона test, 4 control.

### Ответ

**Проблема:** 4 + 4 = 8 кластеров. Для t-test на агрегатах: df = 6. Для cluster-robust SE: нестабильны при < 20 кластерах.

**Варианты:**

1. **Wild cluster bootstrap** — рандомизационный тест на уровне кластеров. Работает при 6–20 кластерах.
2. **Пермутационный тест** — перебрать все C(8,4) = 70 возможных разбиений. Сравнить наблюдаемую разницу с распределением под H₀.
3. **Принять низкую power.** При 4+4 кластерах и ICC > 0 — MDE будет очень большим (>20–30%). Тестируйте только крупные изменения.
4. **Увеличить число кластеров.** Разбить регионы на подрегионы, если interference позволяет.

**Правило:** если кластеров < 10 — think very carefully. Возможно, A/B-тест — не лучший инструмент (рассмотрите diff-in-diff, synthetic control).

---

## Задача 12. CUPED при кластерной рандомизации

**Ситуация:** 40 магазинов (20+20), m = 3 000. ICC = 0.02. Есть pre-period данные, ρ = 0.6 на user-level. Можно ли применить CUPED?

### Ответ

**Да, с оговоркой.** CUPED снижает within-cluster дисперсию (σ²_within). Но design effect определяется ICC, который зависит от σ²_between / σ²_total.

CUPED снижает σ²_within → σ²_total падает → ICC может вырасти (because σ²_between не меняется). Paradox: CUPED reduces total variance, but ICC increases.

**Net effect:** CUPED всё равно помогает: n_eff = n / DEFF, и n_eff_cuped > n_eff_raw, потому что общая дисперсия снижается быстрее, чем растёт DEFF.

**Практика:** (1) Применить CUPED на user-level. (2) Затем — cluster-robust SE на adjusted данных. (3) Ожидаемый выигрыш ≈ ρ² × (1 − ICC fraction), обычно 15–40%.

---

## Задача 13. Marketplace: двусторонний spillover ⚠

**Ситуация:** Маркетплейс тестирует скидку для покупателей. Рандомизация по покупателям. Но: если покупатели в тест-группе покупают больше → продавцы получают больше заказов → меняют цены/ассортимент → это влияет и на control-покупателей.

### Ответ

**Двусторонний spillover:** treatment на demand side (покупатели) влияет на supply side (продавцы), что обратно влияет на demand. User-level рандомизация невалидна — interference через marketplace equilibrium.

**Решение:** рандомизация по географическим регионам (каждый регион — замкнутый рынок) или по категориям товаров (если продавцы не кросс-категорийные).

**Если невозможно:** partial identification, bounds на эффект, или switchback design (чередование treatment/control во времени в одном регионе).

---

## Задача 14. Design effect при разных ICC

**Дано:** 20 кластеров, m = 500.

Рассчитать DEFF для ICC = 0.001, 0.01, 0.05, 0.1.

### Ответ

| ICC | DEFF | n_eff (из 10 000) | Интуиция |
|---|---|---|---|
| 0.001 | 1 + 499 × 0.001 = 1.50 | 6 667 | Почти без потерь |
| 0.01 | 1 + 499 × 0.01 = 5.99 | 1 669 | Power падает заметно |
| 0.05 | 1 + 499 × 0.05 = 25.95 | 385 | Серьёзная потеря |
| 0.1 | 1 + 499 × 0.1 = 50.9 | 196 | Эффективная выборка ≈ число кластеров × ~10 |

**Вывод:** ICC × m — ключевой параметр. Если ICC × m > 1 — power определяется числом кластеров, а не числом пользователей.
