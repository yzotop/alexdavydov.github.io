<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Практика — Модуль 6. Кластерные эксперименты</title>
    <link rel="stylesheet" href="../../assets/style.css">
</head>
<body>
    <div class="container">
        <div class="breadcrumbs">
            <a href="../../../../courses/index.html">Все курсы</a> /
            <a href="../../index.html">Статистика A/B-тестирования</a> /
            <a href="./index.html">Модуль 6</a> / Практика
        </div>

        <div class="nav-links">
            <a href="./index.html">Модуль</a>
            <a href="./practice.html" class="active">Практика</a>
            <a href="./simulators.html">Симуляторы</a>
        </div>

        <h1>Практика</h1>
        <p class="subtitle">Для каждой задачи определите, какая единица рандомизации и анализа корректна, как влияет ICC и design effect, и какой метод inference использовать.</p>

        <!-- Task 1 -->
        <div class="task-card">
            <div class="task-title">Задача 1. Наивный t-test на гео-данных (16 городов)</div>
            <div class="task-body">
                <p>Компания запускает гео-эксперимент: в 8 городах повышают цену доставки (тест), в 8 оставляют старую (контроль). В каждом городе по 200&nbsp;000 пользователей, всего 3.2M пользователей.</p>
                <p>Аналитик выгружает все заказы пользователей за период эксперимента и запускает обычный t-test по среднему чеку на уровне заказов (N &gt; 5M). Получает p = 0.0001 и пишет в отчёте: «эффект значим, повышаем цены».</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Проблема:</strong> рандомизация проведена по городам, а анализ — по миллионам заказов/пользователей. Нарушено допущение независимости наблюдений, effective sample size определяется числом городов (16), а не числом заказов.</p>
                    <p><strong>Последствия:</strong> стандартные ошибки сильно занижены, p-value искусственно мал. Реальная ошибка первого рода намного выше 5%, вывод о значимости может быть ложноположительным.</p>
                    <p><strong>Правильный подход:</strong> агрегировать метрики до уровня города (16 наблюдений) и сравнивать средние по городам, либо использовать регрессию с cluster-robust SE по городам / randomization inference с перестановками treatment между 16 городами.</p>
                </div>
            </details>
        </div>

        <!-- Task 2 -->
        <div class="task-card">
            <div class="task-title">Задача 2. Рассчитать Design Effect</div>
            <div class="task-body">
                <p>У вас эксперимент в розничной сети: 30 магазинов в тесте и 30 в контроле. Средний магазин обслуживает m = 2000 уникальных покупателей за период эксперимента.</p>
                <p>Из pre-period оценили ICC по выручке на покупателя: ICC = 0.02. Нужно оценить design effect и понять, насколько «сжимается» эффективный размер выборки.</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p>Используем формулу:</p>
                    <div class="formula">
                        DEFF = 1 + (m &minus; 1) × ICC
                    </div>
                    <p>Подставим числа:</p>
                    <div class="formula">
                        DEFF = 1 + (2000 &minus; 1) × 0.02 ≈ 1 + 1999 × 0.02 ≈ 1 + 39.98 ≈ 40.98
                    </div>
                    <p>То есть дисперсия метрики примерно в 41 раз выше, чем при независимых наблюдениях.</p>
                    <p>Если всего покупателей n = 60 × 2000 = 120&nbsp;000, то эффективный размер выборки:</p>
                    <div class="formula">
                        n<sub>eff</sub> = 120&nbsp;000 / 40.98 ≈ 2930
                    </div>
                    <p><strong>Вывод:</strong> хотя в эксперименте участвуют 120k покупателей, по информативности он ближе к эксперименту с ~3k независимых наблюдений.</p>
                </div>
            </details>
        </div>

        <!-- Task 3 -->
        <div class="task-card">
            <div class="task-title">Задача 3. Effective sample size — сколько городов нужно?</div>
            <div class="task-body">
                <p>Вы планируете гео-эксперимент по 20 городам (10 тест, 10 контроль). В каждом городе ~100&nbsp;000 пользователей. Хотите детектировать uplift +3% по выручке на пользователя с мощностью 80%.</p>
                <p>Из исторических данных оценили ICC по выручке: 0.01. При user-level предположении power-анализ показывает, что 2M пользователей более чем достаточно.</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Шаг 1.</strong> Оцените design effect. При m = 100k пользователей на город и ICC = 0.01:</p>
                    <div class="formula">
                        DEFF ≈ 1 + (100&nbsp;000 &minus; 1) × 0.01 ≈ 1 + 99999 × 0.01 ≈ 1001
                    </div>
                    <p><strong>Шаг 2.</strong> Эффективный размер выборки по пользователям:</p>
                    <div class="formula">
                        n<sub>eff</sub> = 2&nbsp;000&nbsp;000 / 1001 ≈ 2000
                    </div>
                    <p>Но ключевой ограничитель — число <em>кластеров</em>: всего 20 городов (10 vs 10). Многие методы анализа фактически работают с N = 20 (по одному наблюдению на город).</p>
                    <p><strong>Вывод:</strong> реальная мощность определяется не количеством пользователей, а количеством городов. Для детектирования +3% uplift, скорее всего, 20 городов недостаточно, потребуется либо больше городов, либо более крупный эффект, либо более длинный период (для снижения шума на уровне городов).</p>
                </div>
            </details>
        </div>

        <!-- Task 4 -->
        <div class="task-card">
            <div class="task-title">Задача 4. ICC = 0 — можно ли игнорировать?</div>
            <div class="task-body">
                <p>Вы оценили ICC по метрике GMV per user для кластеров «курьерская зона» и получили ICC ≈ 0.0002. Средний размер кластера m = 5000 пользователей.</p>
                <p>Коллега говорит: «ICC почти ноль, давайте считать, что его нет, и использовать обычный user-level t-test без поправок».</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p>Посчитаем design effect:</p>
                    <div class="formula">
                        DEFF = 1 + (m &minus; 1) × ICC ≈ 1 + (5000 &minus; 1) × 0.0002 ≈ 1 + 4999 × 0.0002 ≈ 1 + 1 ≈ 2
                    </div>
                    <p>Даже при «почти нулевом» ICC = 0.0002, из-за большого размера кластера итоговый DEFF ≈ 2. То есть дисперсия вдвое выше, чем мы бы предполагали при независимых наблюдениях.</p>
                    <p><strong>Вывод:</strong> игнорировать ICC нельзя: вы занижаете стандартные ошибки примерно в √2 раза и завышаете значимость. Нужно либо учитывать clustering (cluster-robust SE), либо агрегировать метрики до уровня кластера.</p>
                </div>
            </details>
        </div>

        <!-- Task 5 -->
        <div class="task-card">
            <div class="task-title">Задача 5. Курьерские зоны — выбор единицы рандомизации</div>
            <div class="task-body">
                <p>Логистическая команда хочет протестировать новый алгоритм распределения заказов по курьерам. Обсуждаются три варианта эксперимента:</p>
                <p><strong>A.</strong> Рандомизация по заказам: каждый заказ независимо попадает в тест или контроль.</p>
                <p><strong>B.</strong> Рандомизация по курьерам: каждый курьер закреплён либо за тестом, либо за контролем, весь поток заказов делится между ними.</p>
                <p><strong>C.</strong> Рандомизация по курьерским зонам: все курьеры и заказы в зоне либо в тесте, либо в контроле.</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Вариант A (по заказам):</strong> сильное нарушение SUTVA. Нагрузка на курьеров зависит от mix тест/контроль, заказы конкурируют за одних и тех же курьеров. Эффект одних заказов влияет на время доставки других.</p>
                    <p><strong>Вариант B (по курьерам):</strong> лучше, но всё ещё есть интерференция: заказы в одной зоне конкурируют между тестовыми и контрольными курьерами.</p>
                    <p><strong>Вариант C (по зонам):</strong> наиболее чистый в терминах каузальности. Внутри зоны все живут в одном treatment, взаимодействия остаются внутри кластера, между зонами независимость куда более правдоподобна.</p>
                    <p><strong>Рекомендация:</strong> выбирать единицу рандомизации на уровне курьерской зоны (C) и далее учитывать clustering в анализе (агрегация по зонам или cluster-robust SE).</p>
                </div>
            </details>
        </div>

        <!-- Task 6 -->
        <div class="task-card">
            <div class="task-title">Задача 6. Гетерогенные кластеры — взвешивание (24 магазина)</div>
            <div class="task-body">
                <p>Эксперимент в офлайн-рознице: 12 магазинов в тесте, 12 в контроле. Магазины сильно различаются по размеру: топ-3 магазина дают 60% общей выручки, остальные 21 магазин — 40%.</p>
                <p>Аналитик агрегирует метрику «выручка на магазин» и считает простой средний эффект по магазинам (невзвешенный t-test по 24 точкам).</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Проблема:</strong> сильная гетерогенность кластеров. Невзвешенный анализ по магазинам даёт каждому магазину равный вес, хотя вклад в общий бизнес радикально различается.</p>
                    <p><strong>Возможные подходы:</strong></p>
                    <ul>
                        <li>Считать магазины с весами, пропорциональными их pre-period выручке (weighted analysis), если вас интересует эффект на общий GMV.</li>
                        <li>Либо отдельно рассматривать большие и маленькие магазины (стратификация), чтобы не смешивать заведомо разные популяции.</li>
                    </ul>
                    <p><strong>Вывод:</strong> при кластерной рандомизации важно не только количество кластеров, но и их размер. Взвешивание помогает приблизить оценку к бизнес-эффекту.</p>
                </div>
            </details>
        </div>

        <!-- Task 7 -->
        <div class="task-card">
            <div class="task-title">Задача 7. Spillover в социальной сети ⚠</div>
            <div class="task-body">
                <p>Социальная сеть тестирует новый алгоритм показа Stories. Рандомизация по пользователям: 50% видят новый алгоритм (тест), 50% — старый (контроль). Метрика: среднее число просмотров Stories per user.</p>
                <p>Пользователи из теста начинают чаще выкладывать Stories (новый алгоритм отдаёт им больше показов), их друзья (в том числе в контроле) видят больше контента и тоже становятся активнее.</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Проблема:</strong> network spillover. Treatment влияет не только на метрику самих treatment-пользователей, но и на их друзей в контроле. Нарушено допущение «отсутствия интерференции» на уровне пользователей.</p>
                    <p><strong>Последствия:</strong> часть uplift в контроле на самом деле вызвана treatment у друзей. Наивная оценка эффекта при rollout может быть смещена: при 100% rollout структура взаимодействий изменится.</p>
                    <p><strong>Что делать:</strong> рассматривать кластеры по социальному графу (компоненты, сообщества) как единицу рандомизации; измерять, как метрика в контроле зависит от доли друзей в тесте; использовать специальные дизайны для графовых экспериментов (clustered network experiments).</p>
                </div>
            </details>
        </div>

        <!-- Task 8 -->
        <div class="task-card">
            <div class="task-title">Задача 8. Рассчитать inflation factor (40 кластеров)</div>
            <div class="task-body">
                <p>Эксперимент: 20 регионов в тесте, 20 в контроле. В каждом регионе примерно одинаковое число пользователей. ICC по CR оценили как 0.03.</p>
                <p>Аналитик хочет понять, насколько наивный t-test по пользователям занижает стандартные ошибки по сравнению с корректным кластерным анализом.</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p>Design effect показывает, во сколько раз возрастает дисперсия. Соответственно, <strong>inflation factor</strong> для стандартной ошибки — это √DEFF.</p>
                    <p>Если средний размер кластера m, то:</p>
                    <div class="formula">
                        DEFF = 1 + (m &minus; 1) × 0.03
                    </div>
                    <p>Например, если m = 10&nbsp;000 пользователей на регион:</p>
                    <div class="formula">
                        DEFF ≈ 1 + 9999 × 0.03 ≈ 1 + 300 ≈ 301
                    </div>
                    <div class="formula">
                        \(\text{SE}_{\text{cluster}}\) ≈ √301 × \(\text{SE}_{\text{naive}}\) ≈ 17.3 × \(\text{SE}_{\text{naive}}\)
                    </div>
                    <p><strong>Вывод:</strong> наивный t-test по пользователям может недооценивать стандартную ошибку более чем в 10–15 раз, а p-value — быть на порядки ниже реальных.</p>
                </div>
            </details>
        </div>

        <!-- Task 9 -->
        <div class="task-card">
            <div class="task-title">Задача 9. Pre-period estimation of ICC</div>
            <div class="task-body">
                <p>Вы готовите гео-эксперимент по городам и хотите заранее оценить ICC по метрике GMV per user, чтобы правильно посчитать мощность. Есть исторические данные за 3 месяца по тем же городам.</p>
                <p>Как практически оценить ICC до запуска эксперимента и какие подводные камни учесть?</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Как оценить:</strong></p>
                    <ul>
                        <li>Возьмите pre-period данные и для каждого пользователя посчитайте GMV за период.</li>
                        <li>Постройте двухуровневую модель или ANOVA: разложите дисперсию на междугороднюю и внутригородскую компоненты.</li>
                        <li>Оцените σ²<sub>between</sub> и σ²<sub>within</sub>, далее ICC = σ²<sub>between</sub> / (σ²<sub>between</sub> + σ²<sub>within</sub>).</li>
                    </ul>
                    <p><strong>Подводные камни:</strong></p>
                    <ul>
                        <li>Pre-period должен быть репрезентативен по сезону и внешним условиям относительно периода эксперимента.</li>
                        <li>Если метрика сильно нестабильна, оценка ICC может иметь большую погрешность — имеет смысл строить доверительный интервал и использовать консервативное (верхнее) значение ICC для power-анализа.</li>
                        <li>Нужно следить, чтобы расчёт ICC не был «замазан» редкими кластерами с очень малым числом пользователей (их лучше объединять или исключать).</li>
                    </ul>
                </div>
            </details>
        </div>

        <!-- Task 10 -->
        <div class="task-card">
            <div class="task-title">Задача 10. Школьный эксперимент — неправильная агрегация ⚠</div>
            <div class="task-body">
                <p>EdTech-платформа проводит эксперимент: новая методика преподавания математики. Рандомизация по классам: 25 классов в тесте, 25 в контроле (всего 50 классов, ~1500 учеников).</p>
                <p>Аналитик считает t-test по оценкам <em>учеников</em> (N = 1500) и получает p = 0.01. При этом, если агрегировать оценки до уровня класса (N = 50), p ≈ 0.12.</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Проблема:</strong> рандомизация по классам, а анализ по ученикам. Внутри класса оценки скоррелированы (общий учитель, контекст), поэтому ученики не независимы. User-level t-test раздувает N и занижает SE.</p>
                    <p><strong>Правильный подход:</strong> анализировать метрику на уровне класса (средний балл по классу) и использовать t-test/перестановочный тест по 50 наблюдениям, либо регрессию с cluster-robust SE по классам.</p>
                    <p><strong>Вывод:</strong> p = 0.01 на уровне учеников — ложное ощущение значимости; p ≈ 0.12 на уровне классов честно отражает неопределённость.</p>
                </div>
            </details>
        </div>

        <!-- Task 11 -->
        <div class="task-card">
            <div class="task-title">Задача 11. Мало кластеров — что делать? ⚠</div>
            <div class="task-body">
                <p>Гео-эксперимент: всего 8 регионов (4 тест, 4 контроль). Каждый регион крупный, пользователей много, но число кластеров очень маленькое.</p>
                <p>Как корректно анализировать такой эксперимент и чего точно <em>не</em> стоит делать?</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Чего нельзя делать:</strong></p>
                    <ul>
                        <li>Нельзя запускать обычный t-test по пользователям — это полностью игнорирует кластерную структуру.</li>
                        <li>Нельзя полагаться на асимптотические формулы cluster-robust SE с 8 кластерами — они дают сильно искажённые p-value.</li>
                    </ul>
                    <p><strong>Что можно делать:</strong></p>
                    <ul>
                        <li>Агрегировать метрику до уровня региона (8 точек) и использовать randomization inference: переставлять treatment-статусы между 8 регионами и считать эмпирическое распределение разницы средних.</li>
                        <li>Строить доверительные интервалы через бутстрап по кластерам (region-level bootstrap).</li>
                        <li>Фокусироваться на величине эффекта и бизнес-контексте, не переинтерпретируя p &gt; 0.05 как «нет эффекта» при столь малом числе кластеров.</li>
                    </ul>
                </div>
            </details>
        </div>

        <!-- Task 12 -->
        <div class="task-card">
            <div class="task-title">Задача 12. CUPED при кластерной рандомизации</div>
            <div class="task-body">
                <p>Вы проводите кластерный эксперимент по магазинам (40 магазинов в тесте, 40 в контроле). Хотите использовать CUPED с pre-period выручкой на магазин, чтобы снизить дисперсию метрики.</p>
                <p>Как правильно применять CUPED в этом случае и на каком уровне строить регрессию?</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Ключевая идея:</strong> CUPED должен уважать единицу рандомизации. Если treatment назначен магазинам, ковариаты и регрессия должны быть построены на уровне магазинов.</p>
                    <p><strong>Правильный подход:</strong></p>
                    <ul>
                        <li>Сначала агрегируйте метрику и pre-period ковариату до уровня магазина (одна точка на магазин).</li>
                        <li>Постройте регрессию метрики периода эксперимента на pre-period выручку (без treatment в регрессоре) и получите скорректированные остатки.</li>
                        <li>Сравнивайте скорректированные значения между тестом и контролем (t-test по магазинам, randomization inference).</li>
                    </ul>
                    <p><strong>Чего избегать:</strong> не нужно считать CUPED на уровне пользователей и затем агрегировать, если рандомизация была кластерной.</p>
                </div>
            </details>
        </div>

        <!-- Task 13 -->
        <div class="task-card">
            <div class="task-title">Задача 13. Marketplace: двусторонний spillover ⚠</div>
            <div class="task-body">
                <p>Маркетплейс тестирует снижение комиссии для части продавцов. Рандомизация по продавцам: 10k продавцов в тесте, 10k в контроле. Покупатели при этом не рандомизируются.</p>
                <p>Метрика: GMV per buyer. В тесте она растёт на +6%, в контроле почти не меняется. Команда хочет экстраполировать этот эффект на 100% продавцов после rollout.</p>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p><strong>Проблема:</strong> двусторонний spillover: treatment назначен продавцам, но метрика измеряется на покупателях, которые взаимодействуют и с тестовыми, и с контрольными продавцами. При 100% rollout структура рынка изменится (не будет контрольных продавцов).</p>
                    <p><strong>Последствия:</strong> +6% GMV per buyer в эксперименте может быть комбинацией прямого эффекта (скидки для тестовых продавцов) и перераспределения трафика/продаж между продавцами (zero-sum для части рынка).</p>
                    <p><strong>Что делать:</strong> анализировать эффекты и на уровне продавца (выигравшие/проигравшие), и на уровне покупателя; рассмотреть кластеризацию по рынкам/категориям; аккуратно моделировать поведение при полном rollout, а не наивно переносить экспериментальное uplift.</p>
                </div>
            </details>
        </div>

        <!-- Task 14 -->
        <div class="task-card">
            <div class="task-title">Задача 14. Design effect при разных ICC</div>
            <div class="task-body">
                <p>У вас кластерный дизайн с фиксированным средним размером кластера m = 1000 пользователей. Нужно понять, как меняется design effect при разных значениях ICC.</p>
                <p>Заполните таблицу (приближённо):</p>
                <table>
                    <thead>
                        <tr>
                            <th>ICC</th>
                            <th>DEFF</th>
                            <th>n<sub>eff</sub> / n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>0.001</td><td>?</td><td>?</td></tr>
                        <tr><td>0.005</td><td>?</td><td>?</td></tr>
                        <tr><td>0.01</td><td>?</td><td>?</td></tr>
                        <tr><td>0.05</td><td>?</td><td>?</td></tr>
                    </tbody>
                </table>
            </div>
            <details>
                <summary>Ответ</summary>
                <div class="task-answer">
                    <p>Используем формулы:</p>
                    <div class="formula">
                        DEFF = 1 + (m &minus; 1) × ICC, &nbsp; n<sub>eff</sub> / n = 1 / DEFF
                    </div>
                    <p>При m = 1000:</p>
                    <table>
                        <thead>
                            <tr>
                                <th>ICC</th>
                                <th>DEFF</th>
                                <th>n<sub>eff</sub> / n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>0.001</td><td>≈ 1 + 999 × 0.001 ≈ 1.999 ≈ 2</td><td>≈ 0.5</td></tr>
                            <tr><td>0.005</td><td>≈ 1 + 999 × 0.005 ≈ 5.995 ≈ 6</td><td>≈ 0.17</td></tr>
                            <tr><td>0.01</td><td>≈ 1 + 999 × 0.01 ≈ 10.99 ≈ 11</td><td>≈ 0.09</td></tr>
                            <tr><td>0.05</td><td>≈ 1 + 999 × 0.05 ≈ 50.95 ≈ 51</td><td>≈ 0.02</td></tr>
                        </tbody>
                    </table>
                    <p><strong>Вывод:</strong> даже «маленькие» ICC типа 0.005–0.01 при больших кластерах драматически уменьшают эффективный размер выборки, и это обязательно нужно учитывать в дизайне эксперимента.</p>
                </div>
            </details>
        </div>

        <nav class="module-nav">
            <a href="../05_variance_reduction/index.html">← Предыдущий модуль</a>
            <a href="../../index.html">К курсу</a>
            <a href="../07_common_mistakes/index.html">Следующий модуль →</a>
        </nav>
    </div>
</body>
</html>
