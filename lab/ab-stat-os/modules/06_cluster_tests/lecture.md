# 06 — Кластерные эксперименты

## 1. Почему user-level рандомизация ломается

Стандартный A/B-тест рандомизирует пользователей: каждый независимо попадает в test или control. Это работает, когда:
- Пользователь видит только свою версию
- Его поведение не зависит от того, в какой группе соседи/коллеги/курьеры

Но в продуктовой реальности это условие часто нарушается.

### Гео-эксперименты

Сервис доставки тестирует новый алгоритм маршрутизации. Нельзя дать разным курьерам в одном городе разные алгоритмы — они конкурируют за одни и те же заказы. Решение: рандомизация по городам. Город = кластер.

### Курьерские зоны

Маркетплейс тестирует бонус курьерам. Если в одной зоне часть курьеров получает бонус, а часть нет — бонусные забирают больше заказов, небонусные теряют. Interference: поведение одного зависит от treatment другого. Нарушение SUTVA (Модуль 01).

### Школы, магазины, регионы

Образовательная платформа тестирует новый формат урока. Ученики в одном классе обсуждают материал — нельзя дать разным ученикам разные версии. Класс = кластер.

Розничная сеть тестирует ценообразование. Покупатели ходят в один магазин — рандомизация по магазинам.

### Network effects и spillover

Социальная сеть тестирует новую ленту. Пользователь видит контент друзей — если друзья в другой группе, их поведение влияет на его опыт. User-level рандомизация → interference → bias.

**Правило:** если treatment одного пользователя может повлиять на outcome другого — нужна кластерная рандомизация. Кластер = группа пользователей, внутри которой есть взаимодействие.

---

## 2. Единица рандомизации ≠ единица анализа

### Что это значит

- **Единица рандомизации (randomization unit):** на каком уровне назначается treatment. В кластерном эксперименте — кластер (город, магазин, зона).
- **Единица анализа (analysis unit):** на каком уровне измеряется outcome. Обычно — пользователь (заказ, сессия).

### Почему несовпадение опасно

Рандомизировали 20 городов (10 test + 10 control). В каждом городе ~50 000 пользователей. Итого: 500K пользователей в каждой группе. Аналитик запускает user-level t-test → p = 0.01. Радость.

Но реальных «независимых наблюдений» — не 500K, а 10 на группу. Пользователи внутри города коррелированы (одни и те же пробки, погода, промо, конкуренция). T-test думает, что SE маленькая (N = 500K), а реальная SE определяется N_clusters = 10.

**Результат:** Type I error rate = 30–50% вместо 5%. Каждый второй «значимый» результат — ложный.

### Пример: CTR в маркетплейсе

Рандомизация по зонам доставки (30 зон). Метрика: CTR на карточку товара. Если анализировать на уровне пользователей — дисперсия занижена, p-value занижен. Если на уровне зон — корректная оценка, но N = 30 → power низкий.

---

## 3. ICC (Intraclass Correlation)

### Что измеряет ICC

ICC (Intraclass Correlation Coefficient) — доля общей дисперсии, объясняемая принадлежностью к кластеру.

ICC = 0: пользователи внутри кластера не похожи друг на друга больше, чем случайные пользователи из разных кластеров. Кластеры не добавляют структуры → можно игнорировать.

ICC = 1: все пользователи внутри кластера идентичны. Каждый кластер — одно наблюдение.

### Интуиция

Представьте 10 городов, в каждом — 50K пользователей. Если конверсия в каждом городе примерно одинакова (разница <0.5%) → ICC низкий (~0.001). Если Москва конвертирует 8%, а Новосибирск 3% → ICC высокий (~0.05–0.1).

ICC = σ²_between / (σ²_between + σ²_within)

- σ²_between — дисперсия между кластерами (насколько средние кластеров отличаются)
- σ²_within — дисперсия внутри кластеров (насколько пользователи отличаются внутри одного кластера)

### Типичные значения

| Контекст | ICC |
|---|---|
| Города, одна страна | 0.001–0.01 |
| Магазины розничной сети | 0.01–0.05 |
| Классы в школе | 0.05–0.20 |
| Курьерские зоны | 0.01–0.05 |
| Районы мегаполиса | 0.005–0.02 |

Даже ICC = 0.01 при больших кластерах (m = 1000) даёт design effect = 11. Это катастрофа для power.

---

## 4. Design Effect и Effective Sample Size

### Формула

**Design Effect (DEFF) = 1 + (m − 1) × ICC**

где m = средний размер кластера (число пользователей в кластере).

### Effective sample size

**n_eff = n / DEFF**

Пример:
- 20 городов × 50 000 пользователей = 1 000 000 пользователей
- ICC = 0.01, m = 50 000
- DEFF = 1 + (50 000 − 1) × 0.01 = 501
- n_eff = 1 000 000 / 501 ≈ 2 000

Миллион пользователей превращается в 2 000 эффективных наблюдений. Или: 20 городов → ~20 «независимых» точек (что интуитивно верно).

### Влияние на MDE и длительность

При n_eff = 2 000 вместо 1 000 000:
- MDE растёт в √500 ≈ 22× раза
- Если MDE без кластеров = 0.5%, с кластерами = ~11%
- Детектировать +2% конверсии при ICC = 0.01 и 20 городах — невозможно

**Вывод:** кластерные эксперименты требуют либо (a) много кластеров, либо (b) очень большого эффекта, либо (c) низкого ICC. Увеличение числа пользователей внутри кластера почти не помогает (после m > 1/ICC отдача нулевая).

---

## 5. Cluster-robust inference

### Два подхода к анализу

**Подход A: Агрегация до уровня кластера**

1. Для каждого кластера рассчитать среднее Y̅_j
2. Сравнить средние test-кластеров и control-кластеров обычным t-test
3. N = число кластеров (не пользователей)

Плюс: простой, интуитивный, работает при малом числе кластеров.
Минус: теряем информацию о within-cluster дисперсии. При разных размерах кластеров — нужно взвешивание.

**Подход B: Cluster-robust standard errors**

Анализ на уровне пользователей, но SE скорректированы на кластерную структуру. Формула Liang-Zeger (sandwich estimator):

SE_cluster > SE_naive (всегда, если ICC > 0)

Плюс: использует всю информацию. Работает при гетерогенных кластерах.
Минус: требует достаточного числа кластеров (≥ 20–30) для асимптотики.

### Когда что использовать

| Ситуация | Подход |
|---|---|
| Мало кластеров (< 20) | Агрегация + t-test |
| 20–50 кластеров | Cluster-robust SE |
| > 50 кластеров | Cluster-robust SE или агрегация |
| Разные размеры кластеров | Cluster-robust SE (или взвешенная агрегация) |

### Wild cluster bootstrap

При малом числе кластеров (6–20) даже cluster-robust SE нестабильны. Альтернатива — wild cluster bootstrap: пермутации на уровне кластеров с корректировкой. Используется в гео-экспериментах (10–30 регионов).

---

## 6. Практический чеклист

Перед запуском кластерного эксперимента:

- [ ] **Определить единицу рандомизации.** Что является кластером? (город, магазин, зона, класс)
- [ ] **Проверить: есть ли interference?** Может ли treatment одного пользователя повлиять на outcome другого внутри кластера?
- [ ] **Оценить ICC.** Использовать исторические данные: однофакторный ANOVA или random effects model.
- [ ] **Рассчитать Design Effect.** DEFF = 1 + (m − 1) × ICC. Если DEFF > 5 — power серьёзно пострадает.
- [ ] **Рассчитать n_eff и MDE.** Сколько «эффективных» наблюдений? Какой минимальный эффект можно детектировать?
- [ ] **Выбрать метод анализа.** Агрегация или cluster-robust SE? При малом N — wild cluster bootstrap.
- [ ] **Зафиксировать план.** ICC, DEFF, метод — в analysis plan до запуска. Не подбирать post-hoc.

**Связь с другими модулями:**
- Каузальность и SUTVA → [Модуль 01](../01_causality/lecture.md)
- Выбор теста при кластеризации → [Test Selection Map](../../simulators/test_selection_map/index.html) (Модуль 04)
- CUPED при кластерах → [Модуль 05](../05_variance_reduction/lecture.md)
- Интерактивная демонстрация → [Cluster Simulator](../../simulators/cluster_simulator/index.html)
