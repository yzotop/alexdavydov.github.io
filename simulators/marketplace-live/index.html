<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <title>Marketplace Auction &amp; Delivery (Live)</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="topbar__left">
        <div class="brand">
          <div class="brand__title">Marketplace Auction &amp; Delivery (Live)</div>
          <div class="brand__subtitle">buyers · sellers · feed · ranking · delivery · trust</div>
        </div>
      </div>

      <div class="topbar__right">
        <span id="statusBadge" class="badge badge--ok">Paused</span>

        <div class="seed">
          <label class="seed__label" for="seedInput">Seed</label>
          <input id="seedInput" class="seed__input" type="number" min="1" max="999999999" step="1" value="42" />
          <button id="randomizeSeedBtn" class="btn btn--ghost" type="button">Randomize</button>
        </div>

        <div class="topbar__buttons">
          <select id="viewModeSelect" class="btn btn--outline" style="padding: 9px 12px; font-size: 13px;">
            <option value="learn">Learn</option>
            <option value="explore">Explore</option>
            <option value="debug">Debug</option>
          </select>
          <button id="storyBtn" class="btn btn--outline" type="button">Story</button>
          <button id="startPauseBtn" class="btn btn--primary" type="button">Start</button>
          <button id="resetBtn" class="btn btn--outline" type="button">Reset</button>
        </div>
      </div>
    </header>

    <main class="page">
      <aside class="panel panel--left">
        <div class="panel__header">
          <div class="panel__title">Controls</div>
          <div class="panel__hint">All controls update live. Seed + Reset makes runs reproducible.</div>
        </div>

        <section class="control-group">
          <div class="control-group__title">A) Traffic</div>
          <div id="controlsTraffic" class="control-group__body"></div>
        </section>

        <section class="control-group">
          <div class="control-group__title">B) Marketplace Policy</div>
          <div id="controlsPolicy" class="control-group__body"></div>
        </section>

        <section class="control-group">
          <div class="control-group__title">C) Supply / Auction</div>
          <div id="controlsSupply" class="control-group__body"></div>
        </section>

        <section class="control-group">
          <div class="control-group__title">D) Delivery / Ops</div>
          <div id="controlsDelivery" class="control-group__body"></div>
        </section>

        <section class="control-group">
          <div class="control-group__title">E) Trust / Fatigue</div>
          <div id="controlsTrust" class="control-group__body"></div>
        </section>
      </aside>

      <section class="center">
        <div class="main-card">
          <div class="main-card__header">
            <div class="main-card__title">Market flow</div>
            <div class="main-card__badges">
              <span id="capBadge" class="badge badge--warn is-hidden">Cap reached</span>
            </div>
          </div>
          <div class="main-card__summary">
            <div id="topSummary" class="panel-summary" aria-live="polite"></div>
            <div id="heroStoryline" class="hero-storyline" aria-live="polite"></div>
            <div id="whyReason" class="why-reason" aria-live="polite"></div>
            <div id="whyExplain" class="why-explain" aria-live="polite"></div>
            <p class="tradeoff-hint">Higher pressure → revenue now ↑, trust ↓ → orders later ↓</p>
          </div>
          <div class="pipeline-container">
            <!-- Canvas для анимаций линий (скрыт, используется только для рисования) -->
            <canvas id="mainCanvas" class="pipeline-canvas"></canvas>
            
            <!-- Pipeline: 5 колонок -->
            <div class="pipeline">
              <!-- Column 1: Buyers stream -->
              <div class="pipeline-col pipeline-col--buyers">
                <div class="pipeline-col__header">Buyers</div>
                <div id="pipelineBuyers" class="pipeline-buyers"></div>
              </div>
              
              <!-- Column 2: Feed / Ranking -->
              <div class="pipeline-col pipeline-col--feed">
                <div class="pipeline-col__header">Feed / Ranking</div>
                <div id="pipelineFeed" class="pipeline-feed"></div>
              </div>
              
              <!-- Column 3: Selected item (Hero) -->
              <div class="pipeline-col pipeline-col--hero">
                <div class="pipeline-col__header">Selected</div>
                <div id="pipelineHero" class="pipeline-hero"></div>
                <div id="pipelineHeroReason" class="pipeline-hero-reason"></div>
              </div>
              
              <!-- Column 4: Order & Queue -->
              <div class="pipeline-col pipeline-col--queue">
                <div class="pipeline-col__header">Order & Queue</div>
                <div id="pipelineQueue" class="pipeline-queue"></div>
                <div id="pipelineCapacity" class="pipeline-capacity"></div>
              </div>
              
              <!-- Column 5: Delivery & Trust -->
              <div class="pipeline-col pipeline-col--trust">
                <div class="pipeline-col__header">Delivery & Trust</div>
                <div id="pipelineDelivery" class="pipeline-delivery"></div>
                <div id="pipelineTrust" class="pipeline-trust">
                  <div class="pipeline-trust__label">Trust (long-term system health)</div>
                  <div class="pipeline-trust__bar">
                    <div id="pipelineTrustFill" class="pipeline-trust__fill"></div>
                  </div>
                  <div id="pipelineTrustValue" class="pipeline-trust__value">0%</div>
                </div>
              </div>
            </div>
          </div>
          <div class="main-card__footer">
            <div class="footer-row">
              <div class="footer-kv"><span class="kv__k">Sim time</span><span id="simTime" class="kv__v">0s</span></div>
              <div class="footer-kv"><span class="kv__k">Active buyers</span><span id="activeBuyers" class="kv__v">0</span></div>
              <div class="footer-kv"><span class="kv__k">Queue</span><span id="queueLen" class="kv__v">0</span></div>
              <div class="footer-kv"><span class="kv__k">FPS</span><span id="fps" class="kv__v">—</span></div>
              <div class="footer-kv"><span class="kv__k">Sim</span><span id="simHz" class="kv__v">—</span></div>
            </div>
          </div>
        </div>

        <details class="howto">
          <summary class="howto__summary">How to read this</summary>
          <div class="howto__body">
            <ul class="howto__list">
              <li>Симулятор показывает pipeline маркетплейса: buyers → feed / ranking → selected item → order & queue → delivery → trust.</li>
              <li>Buyers слева — активные пользователи с разной чувствительностью к цене (price sensitivity) и терпением (patience). Они формируют спрос.</li>
              <li>Feed / Ranking — ключевой механизм: товары упорядочены по выбранной политике (ranking mode) с учётом promoted share.</li>
              <li>Блок Selected — якорь внимания: это товар, выбранный прямо сейчас, с пояснением “selected because”.</li>
              <li>Order & Queue показывает узкое место доставки: рост очереди (queue) и ETA влияет на отмены (cancels) и просрочки (late delivery).</li>
              <li>Trust — долгосрочное здоровье системы (long-term system health): он не даёт мгновенного эффекта, но влияет на будущие CTR / conversion и объём заказов.</li>
              <li>Режимы ранжирования:
                <ul>
                  <li>Quality-first максимизирует пользовательскую ценность (user value) и поддерживает trust.</li>
                  <li>Revenue-first усиливает ставки (bids) и комиссию (take rate), повышая выручку в краткосрочном периоде.</li>
                </ul>
              </li>
              <li>Ключевой trade-off: рост давления (promoted share, take rate) может увеличить revenue сейчас, но снизить trust → ухудшить conversion и orders позже.</li>
            </ul>
          </div>
        </details>
        <p class="decision-hint">This simulator helps reason about short-term revenue vs long-term marketplace health.</p>
      </section>

      <aside class="panel panel--right">
        <div class="panel__header">
          <div class="panel__title">Metrics</div>
        </div>

        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-card__title">Revenue/min <span class="chart-label--muted">(short-term)</span></div>
            <canvas id="chartRevenue" class="chart-canvas"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-card__title">Orders/min</div>
            <canvas id="chartOrders" class="chart-canvas"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-card__title">P90 ETA</div>
            <canvas id="chartETA" class="chart-canvas"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-card__title">Trust <span class="chart-label--muted">(long-term)</span></div>
            <canvas id="chartTrust" class="chart-canvas"></canvas>
          </div>
        </div>

        <div id="metricsMain" class="metrics-grid">
          <div class="metric">
            <div class="metric__k">Revenue/min <span class="metric-label--muted">(short-term)</span></div>
            <div id="mRevenue" class="metric__v">0</div>
          </div>
          <div class="metric">
            <div class="metric__k">Orders/min</div>
            <div id="mOrders" class="metric__v">0</div>
          </div>
          <div class="metric">
            <div class="metric__k">P90 ETA</div>
            <div id="mP90ETA" class="metric__v">0s</div>
          </div>
          <div class="metric">
            <div class="metric__k">Trust <span class="metric-label--muted">(long-term)</span></div>
            <div id="mTrust" class="metric__v">0%</div>
          </div>
          <div class="metric">
            <div class="metric__k">Conversion</div>
            <div id="mConversionMain" class="metric__v">0%</div>
          </div>
          <div class="metric">
            <div class="metric__k">Late rate</div>
            <div id="mLateRateMain" class="metric__v">0%</div>
          </div>
        </div>

        <details id="moreMetrics" class="more-metrics">
          <summary class="more-metrics__summary">More metrics</summary>
          <div class="metrics-grid">
            <div class="metric">
              <div class="metric__k">GMV/min</div>
              <div id="mGMV" class="metric__v">0</div>
            </div>
            <div class="metric">
              <div class="metric__k">Conversion rate</div>
              <div id="mConversion" class="metric__v">0%</div>
            </div>
            <div class="metric">
              <div class="metric__k">Fill rate</div>
              <div id="mFillRate" class="metric__v">0%</div>
            </div>
            <div class="metric">
              <div class="metric__k">Cancel rate</div>
              <div id="mCancelRate" class="metric__v">0%</div>
            </div>
            <div class="metric">
              <div class="metric__k">Late share</div>
              <div id="mLateShare" class="metric__v">0%</div>
            </div>
            <div class="metric">
              <div class="metric__k">Active orders</div>
              <div id="mActiveOrders" class="metric__v">0</div>
            </div>
            <div class="metric">
              <div class="metric__k">Queue len</div>
              <div id="mQueueLen" class="metric__v">0</div>
            </div>
            <div class="metric">
              <div class="metric__k">Avg price shown</div>
              <div id="mAvgPrice" class="metric__v">0</div>
            </div>
            <div class="metric">
              <div class="metric__k">Avg quality shown</div>
              <div id="mAvgQuality" class="metric__v">0.00</div>
            </div>
          </div>
        </details>
      </aside>
    </main>

    <!-- Story Modal -->
    <div id="storyModal" class="modal is-hidden">
      <div class="modal__overlay"></div>
      <div class="modal__content">
        <div class="modal__header">
          <div class="modal__title">Story Scenarios</div>
          <button id="storyModalClose" class="modal__close">×</button>
        </div>
        <div class="modal__body">
          <div class="story-scenarios">
            <div class="story-scenario" data-scenario="auction-overload">
              <div class="story-scenario__title">1. Auction Overload</div>
              <div class="story-scenario__desc">Revenue-first ranking + high promoted share + low capacity → short-term revenue spike, then cancel/late surge, trust drop, revenue decline.</div>
              <button class="btn btn--primary story-scenario__btn">Apply</button>
            </div>
            <div class="story-scenario" data-scenario="ops-upgrade">
              <div class="story-scenario__title">2. Ops Upgrade</div>
              <div class="story-scenario__desc">Increase capacity → ETA and cancel drop → completion and long-term revenue rise.</div>
              <button class="btn btn--primary story-scenario__btn">Apply</button>
            </div>
            <div class="story-scenario" data-scenario="quality-pivot">
              <div class="story-scenario__title">3. Quality Pivot</div>
              <div class="story-scenario__desc">Quality-first + moderate commission → trust recovers → stable growth, but less short-term CPM-like effect.</div>
              <button class="btn btn--primary story-scenario__btn">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="./utils.js"></script>
    <script src="./sim.js"></script>
    <script src="./charts.js"></script>
    <script src="./render.js"></script>
    <script src="./ui.js"></script>
    <script src="./main.js"></script>
  </body>
</html>
