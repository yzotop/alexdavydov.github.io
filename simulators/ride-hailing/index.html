<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />
    <title>Ride-Hailing Simulator (MVP)</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="topbar__left">
        <div class="brand">
          <div class="brand__title">Ride-Hailing Simulator (MVP)</div>
          <div class="brand__subtitle">2D city · drivers · orders · zones · surge · cancellations</div>
        </div>
      </div>

      <div class="topbar__right">
        <div class="seed">
          <label class="seed__label" for="seedInput">Seed</label>
          <input id="seedInput" class="seed__input" type="number" min="1" max="999999999" step="1" />
          <button id="randomizeSeedBtn" class="btn btn--ghost" type="button">Randomize</button>
        </div>
        <div class="topbar__buttons">
          <button id="startPauseBtn" class="btn btn--primary" type="button">Start</button>
          <button id="resetBtn" class="btn btn--outline" type="button">Reset</button>
        </div>
      </div>
    </header>

    <main class="page">
      <aside class="panel panel--left">
        <div class="panel__header">
          <div class="panel__title">Controls</div>
          <div class="panel__hint">Sliders apply live. Heavy changes may take 1–2s.</div>
        </div>

        <section class="control-group">
          <div class="control-group__title">A) Demand &amp; Supply</div>
          <div id="controlsDemandSupply" class="control-group__body"></div>
        </section>

        <section class="control-group">
          <div class="control-group__title">B) Pricing &amp; Behavior</div>
          <div id="controlsPricingBehavior" class="control-group__body"></div>
        </section>

        <section class="control-group">
          <div class="control-group__title">C) City / Zones</div>
          <div id="controlsCityZones" class="control-group__body"></div>
        </section>

        <section class="control-group">
          <div class="control-group__title">D) Policy</div>
          <div id="controlsPolicy" class="control-group__body"></div>
        </section>
      </aside>

      <section class="center">
        <div class="city-card">
          <div class="city-card__header">
            <div class="city-card__title">City</div>
            <div class="city-card__badges">
              <span id="simStatusBadge" class="badge badge--ok">Ready</span>
              <span id="ordersCapBadge" class="badge badge--warn is-hidden">Order cap reached</span>
            </div>
          </div>
          <div class="city-card__summary">
            <div id="topSummary" class="top-summary" aria-live="polite"></div>
          </div>
          <div class="city-card__canvasWrap">
            <canvas id="cityCanvas"></canvas>
          </div>
          <div class="city-card__footer">
            <div class="footer-row">
              <div class="footer-kv">
                <span class="kv__k">Sim time</span>
                <span id="simTime" class="kv__v">0s</span>
              </div>
              <div class="footer-kv">
                <span class="kv__k">Active orders</span>
                <span id="activeOrders" class="kv__v">0</span>
              </div>
              <div class="footer-kv">
                <span class="kv__k">Drivers</span>
                <span id="activeDrivers" class="kv__v">0</span>
              </div>
              <div class="footer-kv">
                <span class="kv__k">FPS</span>
                <span id="fps" class="kv__v">—</span>
              </div>
              <div class="footer-kv">
                <span class="kv__k">Sim</span>
                <span id="simHz" class="kv__v">—</span>
              </div>
            </div>
          </div>
        </div>

        <details class="howto" open>
          <summary class="howto__summary">How to read this</summary>
          <div class="howto__body">
            <ul class="howto__list">
              <li>Заказы (orders) появляются в зонах города в соответствии с выбранным распределением спроса (demand pattern). У каждого заказа есть точка подачи (pickup) и точка высадки (dropoff).</li>
              <li>Матчинг (matching) выполняется пакетно: система периодически назначает свободных водителей (idle drivers) ожидающим заказам, используя пространственный поиск ближайших кандидатов.</li>
              <li>Surge рассчитывается по зонам на основе дисбаланса между ожидающим спросом (pending demand) и доступным предложением (idle supply), затем сглаживается во времени (EMA).</li>
              <li>Отмены (cancellations) возможны до подачи и во время ожидания. Вероятность отмены растёт при увеличении времени подачи (pickup ETA) относительно базового значения ETA₀ (ETA reference).</li>
              <li>Цвета объектов:
                <ul>
                  <li>водители: свободен (gray), едет на подачу (blue), выполняет поездку (green);</li>
                  <li>заказы: ожидает (dot), назначен водителю (ring).</li>
                </ul>
              </li>
              <li>Метрики справа считаются по скользящему окну (rolling window) последних ~60 секунд, графики показывают более длинную динамику во времени.</li>
              <li>Если спрос значительно превышает предложение, очередь заказов может расти. В симуляции введены ограничения на активные заказы, чтобы система оставалась устойчивой.</li>
              <li>Параметр Seed используется для воспроизводимости: при одинаковом seed симуляция развивается одинаково; Randomize меняет стохастическую траекторию.</li>
            </ul>
          </div>
        </details>
      </section>

      <aside class="panel panel--right">
        <div class="panel__header">
          <div class="panel__title">Metrics</div>
          <div class="panel__hint">Updated every 1s (rolling 60s where applicable).</div>
        </div>

        <div class="charts">
          <div class="chart-card">
            <div class="chart-card__header">
              <div class="chart-card__title">Revenue/min</div>
              <div id="cRevenueNow" class="chart-card__now">—</div>
            </div>
            <div class="chart-card__canvasWrap">
              <canvas id="chartRevenue"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-card__header">
              <div class="chart-card__title">P90 pickup ETA</div>
              <div id="cP90EtaNow" class="chart-card__now">—</div>
            </div>
            <div class="chart-card__canvasWrap">
              <canvas id="chartP90Eta"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-card__header">
              <div class="chart-card__title">Cancel rate</div>
              <div id="cCancelNow" class="chart-card__now">—</div>
            </div>
            <div class="chart-card__canvasWrap">
              <canvas id="chartCancel"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-card__header">
              <div class="chart-card__title">Utilization</div>
              <div id="cUtilNow" class="chart-card__now">—</div>
            </div>
            <div class="chart-card__canvasWrap">
              <canvas id="chartUtil"></canvas>
            </div>
          </div>
        </div>

        <div class="metrics-grid" id="metricsGrid">
          <div class="metric">
            <div class="metric__k">Completed trips/min</div>
            <div id="mTripsPerMin" class="metric__v">0</div>
          </div>
          <div class="metric">
            <div class="metric__k">Avg pickup ETA</div>
            <div id="mAvgEta" class="metric__v">0s</div>
          </div>
          <div class="metric">
            <div class="metric__k">P90 pickup ETA</div>
            <div id="mP90Eta" class="metric__v">0s</div>
          </div>
          <div class="metric">
            <div class="metric__k">Cancel rate</div>
            <div id="mCancelRate" class="metric__v">0%</div>
          </div>
          <div class="metric">
            <div class="metric__k">Driver utilization</div>
            <div id="mUtil" class="metric__v">0%</div>
          </div>
          <div class="metric">
            <div class="metric__k">GMV/min</div>
            <div id="mGMVPerMin" class="metric__v">₽0</div>
          </div>
          <div class="metric">
            <div class="metric__k">Platform rev/min</div>
            <div id="mPlatRevPerMin" class="metric__v">₽0</div>
          </div>
          <div class="metric">
            <div class="metric__k">Driver earn/min</div>
            <div id="mDriverEarnPerMin" class="metric__v">₽0</div>
          </div>
          <div class="metric">
            <div class="metric__k">Avg surge multiplier</div>
            <div id="mAvgSurge" class="metric__v">1.00×</div>
          </div>
        </div>
      </aside>
    </main>

    <script defer src="./utils.js"></script>
    <script defer src="./sim.js"></script>
    <script defer src="./render.js"></script>
    <script defer src="./ui.js"></script>
    <script defer src="./main.js"></script>
  </body>
</html>
